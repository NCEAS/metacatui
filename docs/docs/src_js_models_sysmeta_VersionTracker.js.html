<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MetacatUI Dev Docs: Source: src/js/models/sysmeta/VersionTracker.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="/metacatui/assets/css/styles.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">
</head>

<body>

<nav id="nav">
    <a href="/">
      <div class="logo">
<svg class="cat" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="cat" class="svg-inline--fa fa-cat fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M290.59 192c-20.18 0-106.82 1.98-162.59 85.95V192c0-52.94-43.06-96-96-96-17.67 0-32 14.33-32 32s14.33 32 32 32c17.64 0 32 14.36 32 32v256c0 35.3 28.7 64 64 64h176c8.84 0 16-7.16 16-16v-16c0-17.67-14.33-32-32-32h-32l128-96v144c0 8.84 7.16 16 16 16h32c8.84 0 16-7.16 16-16V289.86c-10.29 2.67-20.89 4.54-32 4.54-61.81 0-113.52-44.05-125.41-102.4zM448 96h-64l-64-64v134.4c0 53.02 42.98 96 96 96s96-42.98 96-96V32l-64 64zm-72 80c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16zm80 0c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16z"></path></svg>

<svg width="459px" height="53px" viewBox="0 0 459 53" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="metacatui" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <path d="M16.492,52 C17.212,52 17.812,51.748 18.292,51.244 C18.772,50.74 19.012,50.128 19.012,49.408 L19.012,49.408 L18.94,22.912 L30.82,37.816 C31.204,38.344 31.72,38.764 32.368,39.076 C33.016,39.388 33.7,39.544 34.42,39.544 C35.908,39.544 37.132,38.896 38.092,37.6 L38.092,37.6 L49.684,22.912 L49.684,49.408 C49.684,50.128 49.96,50.74 50.512,51.244 C51.064,51.748 51.7,52 52.42,52 L52.42,52 L62.068,52 C62.788,52 63.388,51.748 63.868,51.244 C64.348,50.74 64.588,50.128 64.588,49.408 L64.588,49.408 L64.588,4.12 C64.588,3.448 64.336,2.86 63.832,2.356 C63.328,1.852 62.74,1.6 62.068,1.6 L62.068,1.6 L52.348,1.6 C51.388,1.6 50.56,1.648 49.864,1.744 C49.168,1.84 48.532,2.152 47.956,2.68 L47.956,2.68 L33.916,17.296 L20.524,2.608 C20.332,2.368 19.972,2.14 19.444,1.924 C18.916,1.708 18.412,1.6 17.932,1.6 L17.932,1.6 L6.772,1.6 C6.052,1.6 5.44,1.852 4.936,2.356 C4.432,2.86 4.18,3.448 4.18,4.12 L4.18,4.12 L4.18,49.408 C4.18,50.08 4.432,50.68 4.936,51.208 C5.44,51.736 6.052,52 6.772,52 L6.772,52 L16.492,52 Z M110.74,52 C111.556,52 112.264,51.676 112.864,51.028 C113.464,50.38 113.764,49.624 113.764,48.76 L113.764,48.76 L113.764,42.568 C113.764,41.608 113.464,40.828 112.864,40.228 C112.264,39.628 111.556,39.328 110.74,39.328 L110.74,39.328 L89.428,39.328 L89.428,32.92 L109.732,32.92 C110.5,32.92 111.184,32.596 111.784,31.948 C112.384,31.3 112.684,30.568 112.684,29.752 L112.684,29.752 L112.684,23.488 C112.684,22.576 112.384,21.82 111.784,21.22 C111.184,20.62 110.5,20.32 109.732,20.32 L109.732,20.32 L89.428,20.32 L89.428,14.488 L110.74,14.488 C111.508,14.488 112.204,14.164 112.828,13.516 C113.452,12.868 113.764,12.136 113.764,11.32 L113.764,11.32 L113.764,5.056 C113.764,4.144 113.464,3.388 112.864,2.788 C112.264,2.188 111.556,1.888 110.74,1.888 L110.74,1.888 L76.756,1.888 C75.94,1.888 75.232,2.188 74.632,2.788 C74.032,3.388 73.732,4.144 73.732,5.056 L73.732,5.056 L73.732,48.76 C73.732,49.624 74.032,50.38 74.632,51.028 C75.232,51.676 75.94,52 76.756,52 L76.756,52 L110.74,52 Z M147.604,52 C148.42,52 149.104,51.688 149.656,51.064 C150.208,50.44 150.484,49.672 150.484,48.76 L150.484,48.76 L150.484,16.216 L161.86,16.216 C162.676,16.216 163.396,15.904 164.02,15.28 C164.644,14.656 164.956,13.936 164.956,13.12 L164.956,13.12 L164.956,4.768 C164.956,4 164.644,3.316 164.02,2.716 C163.396,2.116 162.676,1.816 161.86,1.816 L161.86,1.816 L124.132,1.816 C123.22,1.816 122.464,2.104 121.864,2.68 C121.264,3.256 120.964,3.952 120.964,4.768 L120.964,4.768 L120.964,13.12 C120.964,13.936 121.264,14.656 121.864,15.28 C122.464,15.904 123.22,16.216 124.132,16.216 L124.132,16.216 L135.652,16.216 L135.148,48.832 C135.148,49.744 135.424,50.5 135.976,51.1 C136.528,51.7 137.212,52 138.028,52 L138.028,52 L147.604,52 Z M175.828,52 C176.836,52 177.676,51.82 178.348,51.46 C179.02,51.1 179.452,50.584 179.644,49.912 L179.644,49.912 L181.876,42.712 L197.932,42.712 L200.164,49.912 C200.356,50.584 200.8,51.1 201.496,51.46 C202.192,51.82 203.044,52 204.052,52 L204.052,52 L213.916,52 C215.836,51.712 216.796,50.704 216.796,48.976 C216.796,48.304 216.676,47.596 216.436,46.852 C216.196,46.108 216.052,45.616 216.004,45.376 L216.004,45.376 L199.876,4.84 C199.588,3.976 199.036,3.232 198.22,2.608 C197.404,1.984 196.372,1.648 195.124,1.6 L195.124,1.6 L184.756,1.6 C183.604,1.648 182.608,1.948 181.768,2.5 C180.928,3.052 180.292,3.832 179.86,4.84 L179.86,4.84 L163.876,45.376 C163.828,45.472 163.672,45.916 163.408,46.708 C163.144,47.5 163.012,48.304 163.012,49.12 C163.012,50.752 163.948,51.712 165.82,52 L165.82,52 L175.828,52 Z M195.34,30.544 L184.036,30.544 L189.652,13.624 L195.34,30.544 Z M245.38,53.08 C250.612,53.08 255.652,51.544 260.5,48.472 C261.22,47.944 261.58,47.296 261.58,46.528 C261.58,45.808 261.292,45.16 260.716,44.584 L260.716,44.584 L252.796,36.808 C252.364,36.376 251.836,36.16 251.212,36.16 C250.78,36.16 250.372,36.256 249.988,36.448 C248.356,37.12 246.796,37.456 245.308,37.456 C243.244,37.456 241.348,36.952 239.62,35.944 C237.892,34.936 236.512,33.58 235.48,31.876 C234.448,30.172 233.932,28.336 233.932,26.368 C233.932,24.352 234.436,22.504 235.444,20.824 C236.452,19.144 237.832,17.812 239.584,16.828 C241.336,15.844 243.244,15.352 245.308,15.352 C246.892,15.352 248.332,15.64 249.628,16.216 C250.012,16.408 250.444,16.504 250.924,16.504 C251.548,16.504 252.1,16.264 252.58,15.784 L252.58,15.784 L259.636,8.008 C260.164,7.384 260.428,6.76 260.428,6.136 C260.428,5.224 259.996,4.528 259.132,4.048 C254.86,1.552 250.276,0.304 245.38,0.304 C240.532,0.304 236.032,1.492 231.88,3.868 C227.728,6.244 224.44,9.448 222.016,13.48 C219.592,17.512 218.38,21.904 218.38,26.656 C218.38,31.408 219.592,35.812 222.016,39.868 C224.44,43.924 227.728,47.14 231.88,49.516 C236.032,51.892 240.532,53.08 245.38,53.08 Z M279.796,52 C280.804,52 281.644,51.82 282.316,51.46 C282.988,51.1 283.42,50.584 283.612,49.912 L283.612,49.912 L285.844,42.712 L301.9,42.712 L304.132,49.912 C304.324,50.584 304.768,51.1 305.464,51.46 C306.16,51.82 307.012,52 308.02,52 L308.02,52 L317.884,52 C319.804,51.712 320.764,50.704 320.764,48.976 C320.764,48.304 320.644,47.596 320.404,46.852 C320.164,46.108 320.02,45.616 319.972,45.376 L319.972,45.376 L303.844,4.84 C303.556,3.976 303.004,3.232 302.188,2.608 C301.372,1.984 300.34,1.648 299.092,1.6 L299.092,1.6 L288.724,1.6 C287.572,1.648 286.576,1.948 285.736,2.5 C284.896,3.052 284.26,3.832 283.828,4.84 L283.828,4.84 L267.844,45.376 C267.796,45.472 267.64,45.916 267.376,46.708 C267.112,47.5 266.98,48.304 266.98,49.12 C266.98,50.752 267.916,51.712 269.788,52 L269.788,52 L279.796,52 Z M299.308,30.544 L288.004,30.544 L293.62,13.624 L299.308,30.544 Z M352.588,52 C353.404,52 354.088,51.688 354.64,51.064 C355.192,50.44 355.468,49.672 355.468,48.76 L355.468,48.76 L355.468,16.216 L366.844,16.216 C367.66,16.216 368.38,15.904 369.004,15.28 C369.628,14.656 369.94,13.936 369.94,13.12 L369.94,13.12 L369.94,4.768 C369.94,4 369.628,3.316 369.004,2.716 C368.38,2.116 367.66,1.816 366.844,1.816 L366.844,1.816 L329.116,1.816 C328.204,1.816 327.448,2.104 326.848,2.68 C326.248,3.256 325.948,3.952 325.948,4.768 L325.948,4.768 L325.948,13.12 C325.948,13.936 326.248,14.656 326.848,15.28 C327.448,15.904 328.204,16.216 329.116,16.216 L329.116,16.216 L340.636,16.216 L340.132,48.832 C340.132,49.744 340.408,50.5 340.96,51.1 C341.512,51.7 342.196,52 343.012,52 L343.012,52 L352.588,52 Z M402.052,52.792 C408.1,52.792 412.912,51.628 416.488,49.3 C420.064,46.972 422.536,44.068 423.904,40.588 C425.272,37.108 425.932,33.424 425.884,29.536 C425.884,29.5309474 425.883967,29.5237673 425.8839,29.5144598 L425.883102,29.4330859 C425.879911,29.1480111 425.868211,28.3183158 425.848,26.944 C425.8294,25.6792 425.818008,22.91524 425.813823,18.65212 L425.813103,17.80828 C425.812997,17.66452 425.8129,17.5192 425.81281,17.37232 L425.812,3.904 C425.86,3.184 425.632,2.62 425.128,2.212 C424.624,1.804 423.916,1.6 423.004,1.6 L423.004,1.6 L413.428,1.6 C412.612,1.6 411.904,1.828 411.304,2.284 C410.704,2.74 410.404,3.28 410.404,3.904 L410.404,3.904 L410.26,27.808 C410.26,34.144 407.476,37.312 401.908,37.312 C399.076,37.312 396.832,36.412 395.176,34.612 C393.52,32.812 392.668,30.352 392.62,27.232 L392.62,27.232 L392.332,3.76 C392.332,3.088 392.068,2.56 391.54,2.176 C391.012,1.792 390.268,1.6 389.308,1.6 L389.308,1.6 L379.876,1.6 C378.244,1.6 377.428,2.32 377.428,3.76 L377.428,3.76 L377.5,28.816 C377.5,33.04 378.376,36.964 380.128,40.588 C381.88,44.212 384.592,47.152 388.264,49.408 C391.936,51.664 396.532,52.792 402.052,52.792 Z M449.284,52.144 C450.148,52.144 450.88,51.844 451.48,51.244 C452.08,50.644 452.38,49.84 452.38,48.832 L452.38,48.832 L452.38,4.912 C452.38,4 452.08,3.22 451.48,2.572 C450.88,1.924 450.148,1.6 449.284,1.6 L449.284,1.6 L439.42,1.6 C438.46,1.6 437.692,1.924 437.116,2.572 C436.54,3.22 436.252,4 436.252,4.912 L436.252,4.912 L436.252,48.832 C436.252,49.84 436.54,50.644 437.116,51.244 C437.692,51.844 438.46,52.144 439.42,52.144 L439.42,52.144 L449.284,52.144 Z" id="metacatui" fill="#FCBF49" fill-rule="nonzero"></path>
    </g>
</svg>
</logo>

    </a>
    <h3>Externals</h3><ul><li><a href="external-TaxonomicClassification.html">TaxonomicClassification</a></li></ul><h3>Namespaces</h3><ul><li><a href="AppConfig.html">AppConfig</a></li><li><a href="EMLUtilities.html">EMLUtilities</a></li><li><a href="IconUtilities.html">IconUtilities</a></li><li><a href="MapConfig.html">MapConfig</a></li><li><a href="MetacatUI.html">MetacatUI</a></li><li><a href="SearchParams.html">SearchParams</a></li><li><a href="Utilities.html">Utilities</a></li><li><a href="XMLUtilities.html">XMLUtilities</a></li></ul><h3>Classes</h3><ul><li class='category-heading' data-category='Collections'>Collections</li><li><a href="AccessPolicy.html">AccessPolicy</a></li><li><a href="Citations.html">Citations</a></li><li><a href="DataPackage.html">DataPackage</a></li><li><a href="Filters.html">Filters</a></li><li><a href="ObjectFormats.html">ObjectFormats</a></li><li><a href="ProjectList.html">ProjectList</a></li><li><a href="QualityReport.html">QualityReport</a></li><li><a href="SolrResults.html">SolrResults</a></li><li><a href="Units.html">Units</a></li><li><a href="UserGroup.html">UserGroup</a></li><li class='category-heading' data-category='Collections/Bookkeeper'>Collections/Bookkeeper</li><li><a href="Quotas.html">Quotas</a></li><li><a href="Usages.html">Usages</a></li><li class='category-heading' data-category='Collections/Geohashes'>Collections/Geohashes</li><li><a href="Geohashes.html">Geohashes</a></li><li class='category-heading' data-category='Collections/Maps'>Collections/Maps</li><li><a href="AssetCategories.html">AssetCategories</a></li><li><a href="AssetColors.html">AssetColors</a></li><li><a href="Features.html">Features</a></li><li><a href="GeoPoints.html">GeoPoints</a></li><li><a href="MapAssets.html">MapAssets</a></li><li><a href="VectorFilters.html">VectorFilters</a></li><li><a href="ZoomPresets.html">ZoomPresets</a></li><li class='category-heading' data-category='Collections/Metadata/EML'>Collections/Metadata/EML</li><li><a href="EMLAnnotations.html">EMLAnnotations</a></li><li><a href="EMLAttributes.html">EMLAttributes</a></li><li><a href="EMLEntities.html">EMLEntities</a></li><li><a href="EMLMissingValueCodes.html">EMLMissingValueCodes</a></li><li class='category-heading' data-category='Collections/Ontologies'>Collections/Ontologies</li><li><a href="BioontologyResults.html">BioontologyResults</a></li><li class='category-heading' data-category='Collections/QueryFields'>Collections/QueryFields</li><li><a href="QueryFields.html">QueryFields</a></li><li class='category-heading' data-category='Collections/SearchSelect'>Collections/SearchSelect</li><li><a href="SearchSelectOptions.html">SearchSelectOptions</a></li><li class='category-heading' data-category='Common'>Common</li><li><a href="ResourceMapResolver.html">ResourceMapResolver</a></li><li class='category-heading' data-category='Errors'>Errors</li><li><a href="EmptyAttributeListError.html">EmptyAttributeListError</a></li><li><a href="InvalidAttributeListError.html">InvalidAttributeListError</a></li><li class='category-heading' data-category='Models'>Models</li><li><a href="AccessRule.html">AccessRule</a></li><li><a href="Accordion.html">Accordion</a></li><li><a href="AppModel.html">AppModel</a></li><li><a href="CitationModel.html">CitationModel</a></li><li><a href="CollectionModel.html">CollectionModel</a></li><li><a href="CrossRef.html">CrossRef</a></li><li><a href="DataONEObject.html">DataONEObject</a></li><li><a href="LookupModel.html">LookupModel</a></li><li><a href="Map.html">Map</a></li><li><a href="Metrics.html">Metrics</a></li><li><a href="PackageModel.html">PackageModel</a></li><li><a href="QualityCheck.html">QualityCheck</a></li><li><a href="Search.html">Search</a></li><li><a href="SolrResult.html">SolrResult</a></li><li><a href="Stats.html">Stats</a></li><li><a href="UserModel.html">UserModel</a></li><li class='category-heading' data-category='Models/Accordion'>Models/Accordion</li><li><a href="AccordionItem.html">AccordionItem</a></li><li class='category-heading' data-category='Models/Analytics'>Models/Analytics</li><li><a href="Analytics.html">Analytics</a></li><li><a href="GoogleAnalytics.html">GoogleAnalytics</a></li><li class='category-heading' data-category='Models/Bookkeeper'>Models/Bookkeeper</li><li><a href="Quota.html">Quota</a></li><li><a href="Subscription.html">Subscription</a></li><li><a href="Usage.html">Usage</a></li><li class='category-heading' data-category='Models/Connectors'>Models/Connectors</li><li><a href="BioontologyAccordionSearchSelect.html">BioontologyAccordionSearchSelect</a></li><li><a href="FiltersMapConnector.html">FiltersMapConnector</a></li><li><a href="FiltersSearchConnector.html">FiltersSearchConnector</a></li><li><a href="GeoPointsCesiumConnector.html">GeoPointsCesiumConnector</a></li><li><a href="GeoPointsCesiumPointsConnector.html">GeoPointsCesiumPointsConnector</a></li><li><a href="GeoPointsCesiumPolygonConnector.html">GeoPointsCesiumPolygonConnector</a></li><li><a href="MapSearchConnector.html">MapSearchConnector</a></li><li><a href="MapSearchFiltersConnector.html">MapSearchFiltersConnector</a></li><li class='category-heading' data-category='Models/Filters'>Models/Filters</li><li><a href="BooleanFilter.html">BooleanFilter</a></li><li><a href="ChoiceFilter.html">ChoiceFilter</a></li><li><a href="DateFilter.html">DateFilter</a></li><li><a href="Filter.html">Filter</a></li><li><a href="FilterGroup.html">FilterGroup</a></li><li><a href="NumericFilter.html">NumericFilter</a></li><li><a href="SpatialFilter.html">SpatialFilter</a></li><li><a href="ToggleFilter.html">ToggleFilter</a></li><li class='category-heading' data-category='Models/Formats'>Models/Formats</li><li><a href="ObjectFormat.html">ObjectFormat</a></li><li class='category-heading' data-category='Models/Geocoder'>Models/Geocoder</li><li><a href="GeocodedLocation.html">GeocodedLocation</a></li><li><a href="GeocoderSearch.html">GeocoderSearch</a></li><li><a href="GoogleMapsAutocompleter.html">GoogleMapsAutocompleter</a></li><li><a href="GoogleMapsGeocoder.html">GoogleMapsGeocoder</a></li><li><a href="Prediction.html">Prediction</a></li><li class='category-heading' data-category='Models/Geohashes'>Models/Geohashes</li><li><a href="Geohash.html">Geohash</a></li><li class='category-heading' data-category='Models/Maps'>Models/Maps</li><li><a href="AssetCategory.html">AssetCategory</a></li><li><a href="AssetColor.html">AssetColor</a></li><li><a href="AssetColorPalette.html">AssetColorPalette</a></li><li><a href="ExpansionPanelsModel.html">ExpansionPanelsModel</a></li><li><a href="Feature.html">Feature</a></li><li><a href="GeoBoundingBox.html">GeoBoundingBox</a></li><li><a href="GeoPoint.html">GeoPoint</a></li><li><a href="GeoScale.html">GeoScale</a></li><li><a href="GeoUtilities.html">GeoUtilities</a></li><li><a href="MapInteraction.html">MapInteraction</a></li><li><a href="MapModel.html">MapModel</a></li><li><a href="VectorFilter.html">VectorFilter</a></li><li><a href="ViewfinderModel.html">ViewfinderModel</a></li><li><a href="ZoomPresetModel.html">ZoomPresetModel</a></li><li class='category-heading' data-category='Models/Maps/Assets'>Models/Maps/Assets</li><li><a href="Cesium3DTileset.html">Cesium3DTileset</a></li><li><a href="CesiumGeohash.html">CesiumGeohash</a></li><li><a href="CesiumImagery.html">CesiumImagery</a></li><li><a href="CesiumTerrain.html">CesiumTerrain</a></li><li><a href="CesiumVectorData.html">CesiumVectorData</a></li><li><a href="MapAsset.html">MapAsset</a></li><li class='category-heading' data-category='Models/Metadata'>Models/Metadata</li><li><a href="ScienceMetadata.html">ScienceMetadata</a></li><li class='category-heading' data-category='Models/Metadata/EML'>Models/Metadata/EML</li><li><a href="EMLMethodStep.html">EMLMethodStep</a></li><li><a href="EMLSpecializedText.html">EMLSpecializedText</a></li><li><a href="EMLTaxonCoverage.html">EMLTaxonCoverage</a></li><li class='category-heading' data-category='Models/Metadata/EML211'>Models/Metadata/EML211</li><li><a href="EML211.html">EML211</a></li><li><a href="EMLAnnotation.html">EMLAnnotation</a></li><li><a href="EMLAttribute.html">EMLAttribute</a></li><li><a href="EMLAttributeList.html">EMLAttributeList</a></li><li><a href="EMLDataTable.html">EMLDataTable</a></li><li><a href="EMLDistribution.html">EMLDistribution</a></li><li><a href="EMLEntity.html">EMLEntity</a></li><li><a href="EMLGeoCoverage.html">EMLGeoCoverage</a></li><li><a href="EMLMeasurementScale.html">EMLMeasurementScale</a></li><li><a href="EMLMethods.html">EMLMethods</a></li><li><a href="EMLMissingValueCode.html">EMLMissingValueCode</a></li><li><a href="EMLNonNumericDomain.html">EMLNonNumericDomain</a></li><li><a href="EMLNumericDomain.html">EMLNumericDomain</a></li><li><a href="EMLOtherEntity.html">EMLOtherEntity</a></li><li><a href="EMLParty.html">EMLParty</a></li><li><a href="EMLReferences.html">EMLReferences</a></li><li><a href="EMLTemporalCoverage.html">EMLTemporalCoverage</a></li><li><a href="EMLText211.html">EMLText211</a></li><li><a href="EMLUnit.html">EMLUnit</a></li><li class='category-heading' data-category='Models/Metadata/EML220'>Models/Metadata/EML220</li><li><a href="EMLText.html">EMLText</a></li><li class='category-heading' data-category='Models/Ontologies'>Models/Ontologies</li><li><a href="BioOntology.html">BioOntology</a></li><li><a href="Bioontology_.html">Bioontology</a></li><li><a href="BioontologyBatch.html">BioontologyBatch</a></li><li><a href="BioontologyClass.html">BioontologyClass</a></li><li class='category-heading' data-category='Models/Portals'>Models/Portals</li><li><a href="PortalImage.html">PortalImage</a></li><li><a href="PortalModel.html">PortalModel</a></li><li><a href="PortalSectionModel.html">PortalSectionModel</a></li><li class='category-heading' data-category='Models/Projects'>Models/Projects</li><li><a href="Project.html">Project</a></li><li class='category-heading' data-category='Models/QueryFields'>Models/QueryFields</li><li><a href="QueryField.html">QueryField</a></li><li class='category-heading' data-category='Models/SearchSelect'>Models/SearchSelect</li><li><a href="AccountSearchSelect.html">AccountSearchSelect</a></li><li><a href="QueryFieldSearchSelect.html">QueryFieldSearchSelect</a></li><li><a href="SearchSelect.html">SearchSelect</a></li><li><a href="SelectOptionModel.html">SelectOptionModel</a></li><li><a href="SolrAutocomplete.html">SolrAutocomplete</a></li><li class='category-heading' data-category='Models/SysMeta'>Models/SysMeta</li><li><a href="VersionTracker.html">VersionTracker</a></li><li class='category-heading' data-category='Models/schemaOrg'>Models/schemaOrg</li><li><a href="SchemaOrgModel.html">SchemaOrgModel</a></li><li class='category-heading' data-category='Router'>Router</li><li><a href="UIRouter.html">UIRouter</a></li><li class='category-heading' data-category='Views'>Views</li><li><a href="AccessPolicyView.html">AccessPolicyView</a></li><li><a href="AccessRuleView.html">AccessRuleView</a></li><li><a href="AnnotationView.html">AnnotationView</a></li><li><a href="AppView.html">AppView</a></li><li><a href="CanonicalDatasetHandlerView.html">CanonicalDatasetHandlerView</a></li><li><a href="CatalogSearchView.html">CatalogSearchView</a></li><li><a href="CitationHeaderView.html">CitationHeaderView</a></li><li><a href="CitationListView.html">CitationListView</a></li><li><a href="CitationModalView.html">CitationModalView</a></li><li><a href="CitationView.html">CitationView</a></li><li><a href="ColorPaletteView.html">ColorPaletteView</a></li><li><a href="DataCatalogView.html">DataCatalogView</a></li><li><a href="DataCatalogViewWithFilters.html">DataCatalogViewWithFilters</a></li><li><a href="DataItemView.html">DataItemView</a></li><li><a href="DataObjectView.html">DataObjectView</a></li><li><a href="DataPackageView.html">DataPackageView</a></li><li><a href="DownloadButtonView.html">DownloadButtonView</a></li><li><a href="DraftsView.html">DraftsView</a></li><li><a href="EditCollectionView.html">EditCollectionView</a></li><li><a href="EditorView.html">EditorView</a></li><li><a href="FooterView.html">FooterView</a></li><li><a href="GroupListView.html">GroupListView</a></li><li><a href="ImageUploaderView.html">ImageUploaderView</a></li><li><a href="MarkdownEditorView.html">MarkdownEditorView</a></li><li><a href="MarkdownView.html">MarkdownView</a></li><li><a href="MdqRunView.html">MdqRunView</a></li><li><a href="MetadataView.html">MetadataView</a></li><li><a href="MetricModalView.html">MetricModalView</a></li><li><a href="MetricView.html">MetricView</a></li><li><a href="MetricsChartView.html">MetricsChartView</a></li><li><a href="NavbarView.html">NavbarView</a></li><li><a href="RegisterCitationView.html">RegisterCitationView</a></li><li><a href="SearchResultView.html">SearchResultView</a></li><li><a href="SignInView.html">SignInView</a></li><li><a href="TOCView.html">TOCView</a></li><li><a href="TableEditorView.html">TableEditorView</a></li><li><a href="UserGroupView.html">UserGroupView</a></li><li><a href="UserView.html">UserView</a></li><li><a href="ViewDataButtonView.html">ViewDataButtonView</a></li><li class='category-heading' data-category='Views/Accordion'>Views/Accordion</li><li><a href="AccordionItemView.html">AccordionItemView</a></li><li><a href="AccordionView.html">AccordionView</a></li><li class='category-heading' data-category='Views/Filters'>Views/Filters</li><li><a href="BooleanFilterView.html">BooleanFilterView</a></li><li><a href="ChoiceFilterView.html">ChoiceFilterView</a></li><li><a href="DateFilterView.html">DateFilterView</a></li><li><a href="FilterEditorView.html">FilterEditorView</a></li><li><a href="FilterGroupView.html">FilterGroupView</a></li><li><a href="FilterGroupsView.html">FilterGroupsView</a></li><li><a href="FilterView.html">FilterView</a></li><li><a href="NumericFilterView.html">NumericFilterView</a></li><li><a href="SemanticFilterView.html">SemanticFilterView</a></li><li><a href="ToggleFilterView.html">ToggleFilterView</a></li><li class='category-heading' data-category='Views/Maps'>Views/Maps</li><li><a href="CesiumWidgetView.html">CesiumWidgetView</a></li><li><a href="DownloadPanelView.html">DownloadPanelView</a></li><li><a href="FeatureInfoView.html">FeatureInfoView</a></li><li><a href="LayerCategoryListView.html">LayerCategoryListView</a></li><li><a href="LayerDetailView.html">LayerDetailView</a></li><li><a href="LayerDetailsView.html">LayerDetailsView</a></li><li><a href="LayerInfoView.html">LayerInfoView</a></li><li><a href="LayerItemView.html">LayerItemView</a></li><li><a href="LayerListView.html">LayerListView</a></li><li><a href="LayerNavigationView.html">LayerNavigationView</a></li><li><a href="LayerOpacityView.html">LayerOpacityView</a></li><li><a href="LayersPanelView.html">LayersPanelView</a></li><li><a href="MapHelpPanel.html">MapHelpPanel</a></li><li><a href="MapView.html">MapView</a></li><li><a href="MapWidgetContainerView.html">MapWidgetContainerView</a></li><li><a href="PredictionView.html">PredictionView</a></li><li><a href="PredictionsListView.html">PredictionsListView</a></li><li><a href="ScaleBarView.html">ScaleBarView</a></li><li><a href="SchemaOrgView.html">SchemaOrgView</a></li><li><a href="SearchInputView.html">SearchInputView</a></li><li><a href="SearchView.html">SearchView</a></li><li><a href="ShareUrlView.html">ShareUrlView</a></li><li><a href="ToolbarView.html">ToolbarView</a></li><li><a href="VectorFilterView.html">VectorFilterView</a></li><li><a href="ViewfinderView.html">ViewfinderView</a></li><li class='category-heading' data-category='Views/Maps/Legend'>Views/Maps/Legend</li><li><a href="CategoricalSwatchView.html">CategoricalSwatchView</a></li><li><a href="ContinuousSwatchView.html">ContinuousSwatchView</a></li><li><a href="LayerLegendView.html">LayerLegendView</a></li><li><a href="LegendContainerView.html">LegendContainerView</a></li><li class='category-heading' data-category='Views/Maps/Viewfinder'>Views/Maps/Viewfinder</li><li><a href="ExpansionPanelView.html">ExpansionPanelView</a></li><li><a href="ZoomPresetView.html">ZoomPresetView</a></li><li><a href="ZoomPresetsListView.html">ZoomPresetsListView</a></li><li class='category-heading' data-category='Views/Metadata'>Views/Metadata</li><li><a href="AutofillAttributesView.html">AutofillAttributesView</a></li><li><a href="EML211EditorView.html">EML211EditorView</a></li><li><a href="EMLAttributeView.html">EMLAttributeView</a></li><li><a href="EMLAttributesView.html">EMLAttributesView</a></li><li><a href="EMLEntityView.html">EMLEntityView</a></li><li><a href="EMLMeasurementScaleView.html">EMLMeasurementScaleView</a></li><li><a href="EMLMeasurementTypeView.html">EMLMeasurementTypeView</a></li><li><a href="EMLMethodsView.html">EMLMethodsView</a></li><li><a href="EMLMissingValueCodeView.html">EMLMissingValueCodeView</a></li><li><a href="EMLMissingValueCodesView.html">EMLMissingValueCodesView</a></li><li><a href="EMLOtherEntityView.html">EMLOtherEntityView</a></li><li><a href="EMLPartyView.html">EMLPartyView</a></li><li><a href="EMLTempCoverageView.html">EMLTempCoverageView</a></li><li><a href="EMLView.html">EMLView</a></li><li><a href="EMlGeoCoverageView_.html">EMlGeoCoverageView</a></li><li><a href="ScienceMetadataView.html">ScienceMetadataView</a></li><li class='category-heading' data-category='Views/Ontologies'>Views/Ontologies</li><li><a href="BioontologyBrowser.html">BioontologyBrowser</a></li><li class='category-heading' data-category='Views/Portals'>Views/Portals</li><li><a href="PortalDataView.html">PortalDataView</a></li><li><a href="PortalHeaderView.html">PortalHeaderView</a></li><li><a href="PortalListView.html">PortalListView</a></li><li><a href="PortalLogosView.html">PortalLogosView</a></li><li><a href="PortalMembersView.html">PortalMembersView</a></li><li><a href="PortalSectionView.html">PortalSectionView</a></li><li><a href="PortalUsagesView.html">PortalUsagesView</a></li><li><a href="PortalView.html">PortalView</a></li><li><a href="PortalVisualizationsView.html">PortalVisualizationsView</a></li><li><a href="PortalsSearchView.html">PortalsSearchView</a></li><li class='category-heading' data-category='Views/Portals/Editor'>Views/Portals/Editor</li><li><a href="PortEditorDataView.html">PortEditorDataView</a></li><li><a href="PortEditorImageView.html">PortEditorImageView</a></li><li><a href="PortEditorLogosView.html">PortEditorLogosView</a></li><li><a href="PortEditorMdSectionView.html">PortEditorMdSectionView</a></li><li><a href="PortEditorSectionView.html">PortEditorSectionView</a></li><li><a href="PortEditorSectionsView.html">PortEditorSectionsView</a></li><li><a href="PortEditorSettingsView.html">PortEditorSettingsView</a></li><li><a href="PortalEditorView.html">PortalEditorView</a></li><li class='category-heading' data-category='Views/Projects'>Views/Projects</li><li><a href="ProjectView.html">ProjectView</a></li><li class='category-heading' data-category='Views/QueryBuilder'>Views/QueryBuilder</li><li><a href="QueryBuilderView.html">QueryBuilderView</a></li><li><a href="QueryRuleView.html">QueryRuleView</a></li><li class='category-heading' data-category='Views/Search'>Views/Search</li><li><a href="SearchResultsPagerView.html">SearchResultsPagerView</a></li><li><a href="SearchResultsView.html">SearchResultsView</a></li><li><a href="SorterView.html">SorterView</a></li><li class='category-heading' data-category='Views/SearchSelect'>Views/SearchSelect</li><li><a href="AccountSelectView.html">AccountSelectView</a></li><li><a href="AnnotationFilter.html">AnnotationFilter</a></li><li><a href="BioontologySelectView.html">BioontologySelectView</a></li><li><a href="NodeSelect.html">NodeSelect</a></li><li><a href="ObjectFormatSelect.html">ObjectFormatSelect</a></li><li><a href="QueryFieldSelectView.html">QueryFieldSelectView</a></li><li><a href="SearchSelectView.html">SearchSelectView</a></li><li><a href="SeparatorView.html">SeparatorView</a></li><li class='category-heading' data-category='Views/UIElements'>Views/UIElements</li><li><a href="ToggleView.html">ToggleView</a></li><li><a href="EMLTaxonView.html">EMLTaxonView</a></li><li><a href="EventLog.html">EventLog</a></li><li><a href="SystemMetadata.html">SystemMetadata</a></li><li class='category-heading' data-category='Deprecated'>Deprecated</li><li><a href="AnnotatorView.html">AnnotatorView</a></li><li><a href="ExternalView.html">ExternalView</a></li><li><a href="LogsSearch.html">LogsSearch</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addClassesFromResponse">addClassesFromResponse</a></li><li><a href="global.html#addFields">addFields</a></li><li><a href="global.html#addSelected">addSelected</a></li><li><a href="global.html#adjustDescriptionLength">adjustDescriptionLength</a></li><li><a href="global.html#appConfigPath">appConfigPath</a></li><li><a href="global.html#buildChildrenUrl">buildChildrenUrl</a></li><li><a href="global.html#buildSearchUrl">buildSearchUrl</a></li><li><a href="global.html#canChangeSeparator">canChangeSeparator</a></li><li><a href="global.html#changeSubmenuOnSearch">changeSubmenuOnSearch</a></li><li><a href="global.html#couldBeLatLong">couldBeLatLong</a></li><li><a href="global.html#createBatchPayload">createBatchPayload</a></li><li><a href="global.html#createHeaders">createHeaders</a></li><li><a href="global.html#defaults">defaults</a></li><li><a href="global.html#encodeIfPresent">encodeIfPresent</a></li><li><a href="global.html#excludeFields">excludeFields</a></li><li><a href="global.html#fetchClasses">fetchClasses</a></li><li><a href="global.html#fetchClassesFromOntology">fetchClassesFromOntology</a></li><li><a href="global.html#fetchFromOntologies">fetchFromOntologies</a></li><li><a href="global.html#fetchQueryFields">fetchQueryFields</a></li><li><a href="global.html#fieldToOption">fieldToOption</a></li><li><a href="global.html#filterClassesToFetch">filterClassesToFetch</a></li><li><a href="global.html#finalizeFetch">finalizeFetch</a></li><li><a href="global.html#formatResult">formatResult</a></li><li><a href="global.html#formatResults">formatResults</a></li><li><a href="global.html#generateGeoJSONPoint">generateGeoJSONPoint</a></li><li><a href="global.html#generateGeoJSONPolygon">generateGeoJSONPolygon</a></li><li><a href="global.html#generateGeoJSONString">generateGeoJSONString</a></li><li><a href="global.html#generateIdentifier">generateIdentifier</a></li><li><a href="global.html#generateSpatialCoverage">generateSpatialCoverage</a></li><li><a href="global.html#getAccountDetails">getAccountDetails</a></li><li><a href="global.html#getCachedClasses">getCachedClasses</a></li><li><a href="global.html#getCategoryNames">getCategoryNames</a></li><li><a href="global.html#getChildren">getChildren</a></li><li><a href="global.html#getClasses">getClasses</a></li><li><a href="global.html#getDOIURL">getDOIURL</a></li><li><a href="global.html#getIncludeParam">getIncludeParam</a></li><li><a href="global.html#getNextPage">getNextPage</a></li><li><a href="global.html#getNextSeparator">getNextSeparator</a></li><li><a href="global.html#getOptionByLabelOrValue">getOptionByLabelOrValue</a></li><li><a href="global.html#getOptionsByCategory">getOptionsByCategory</a></li><li><a href="global.html#getQueryFieldOptions">getQueryFieldOptions</a></li><li><a href="global.html#getSelectedModels">getSelectedModels</a></li><li><a href="global.html#hasInvalidSelections">hasInvalidSelections</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initializeFetch">initializeFetch</a></li><li><a href="global.html#isValidValue">isValidValue</a></li><li><a href="global.html#model">model</a></li><li><a href="global.html#moveClassesToNotFound">moveClassesToNotFound</a></li><li><a href="global.html#optionsAsJSON">optionsAsJSON</a></li><li><a href="global.html#padDescription">padDescription</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#recordError">recordError</a></li><li><a href="global.html#removeSelected">removeSelected</a></li><li><a href="global.html#renameCategory">renameCategory</a></li><li><a href="global.html#reset">reset</a></li><li><a href="global.html#resetPageInfo">resetPageInfo</a></li><li><a href="global.html#responseAsync">responseAsync</a></li><li><a href="global.html#restoreTypes">restoreTypes</a></li><li><a href="global.html#separatorRequired">separatorRequired</a></li><li><a href="global.html#serialize">serialize</a></li><li><a href="global.html#setAddedFieldDetails">setAddedFieldDetails</a></li><li><a href="global.html#setDataCatalogSchema">setDataCatalogSchema</a></li><li><a href="global.html#setDatasetSchema">setDatasetSchema</a></li><li><a href="global.html#setNextSeparator">setNextSeparator</a></li><li><a href="global.html#setOptionsForPreselected">setOptionsForPreselected</a></li><li><a href="global.html#setSchema">setSchema</a></li><li><a href="global.html#setSchemaFromTemplate">setSchemaFromTemplate</a></li><li><a href="global.html#setSelected">setSelected</a></li><li><a href="global.html#sortByProp">sortByProp</a></li><li><a href="global.html#sortFields">sortFields</a></li><li><a href="global.html#toAccordionItem">toAccordionItem</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#toSearchSelectOption">toSearchSelectOption</a></li><li><a href="global.html#truncateDescription">truncateDescription</a></li><li><a href="global.html#updateOptions">updateOptions</a></li><li><a href="global.html#url">url</a></li><li><a href="global.html#waitForFetchComplete">waitForFetchComplete</a></li></ul>
</nav>

<div id="main">

    <h1 class="page-title">Source: src/js/models/sysmeta/VersionTracker.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>define(["backbone", "models/sysmeta/SysMeta", "localforage", "md5"], (
  Backbone,
  SysMeta,
  localforage,
  md5,
) => {
  const DEFAULT_TTL_MS = 24 * 60 * 60 * 1000; // 1 day
  const { DEFAULT_META_SERVICE_URL } = SysMeta;
  const DEFAULT_MAX_CHAIN_HOPS = 200;
  const DEFAULT_MAX_CACHE_RECORDS = 5000;

  // Fields to persist from SysMeta in the cache
  const PERSISTED_SYS_META_FIELDS = [
    "formatId",
    "size",
    "checksum",
    "checksumAlgorithm",
    "rightsHolder",
    "dateUploaded",
    "dateSysMetadataModified",
    "fileName",
  ];

  const IS_LOCAL_FORAGE = (store) =>
    store &amp;&amp;
    typeof store.setItem === "function" &amp;&amp;
    typeof store.getItem === "function";

  const NORMALIZE_METASERVICE_URL = (url) => {
    let normalUrl = typeof url !== "string" ? DEFAULT_META_SERVICE_URL : url;
    normalUrl = normalUrl.trim();
    return normalUrl.endsWith("/") ? normalUrl : `${normalUrl}/`;
  };

  /**
   * @typedef {object} VersionResult
   * @property {string} pid - The PID of the version at the requested offset.
   * @property {SysMeta|null} sysMeta - SysMeta object for the PID, or null if
   * not fetched yet. If `withMeta` is true, this will always be populated.
   */

  /**
   * @typedef {object} VersionRecord
   * @property {string[]|VersionResult[]} next - List of PIDs that are newer.
   * May be either strings (PIDs) or objects with { pid, sysMeta } if `withMeta`
   * is true.
   * @property {string[]|VersionResult[]} prev - List of PIDs that are older.
   * May be either strings (PIDs) or objects with { pid, sysMeta } if `withMeta`
   * is true.
   * @property {boolean} endNext - true if there are no newer versions detected
   * from the SysMeta service. This is not a guarantee that no newer versions
   * exist, just that the chain is complete up to the last known version.
   * @property {boolean} endPrev - true if there are no older versions detected
   * from the SysMeta service. This is not a guarantee that no older versions
   * exist, just that the chain is complete up to the first known version.
   * @property {SysMeta|null} sysMeta - SysMeta object for the PID, or null if
   * not fetched yet. If `withMeta` is true, this will always be populated.
   */

  /**
   * @class VersionTracker
   * @classcategory Models/SysMeta
   * @since 2.34.0
   * @classdesc VersionTracker walks sysmeta version chains and caches them in
   * memory and in localForage for fast access. It allows getting PIDs at
   * arbitrary offsets from a given PID, fetching full version chains, and
   * listening for updates. It also supports manually adding a new version to
   * the chain (e.g. when a document has been updated in the editor and the new
   * version is known). A store is created for each unique SysMeta service URL,
   * so multiple VersionTracker instances can coexist without conflicts.
   * @example
   * const vt = new VersionTracker({
   *  metaServiceUrl: "https://example.com/sysmeta",
   * })
   * vt.getNth("pid123", 1).then((result) => {
   *  console.log("Next version PID:", result.pid);
   * });
   * const fullChain = await vt.getFullChain("pid123");
   * console.log("All versions in chain:", fullChain.prev, fullChain.next);
   * @example
   * // Get a singleton instance for a specific SysMeta service URL
   * // This will create a new instance if it doesn't exist yet.
   * const vt = VersionTracker.get("https://example.com/sysmeta");
   */
  class VersionTracker {
    /**
     * Create a new VersionTracker instance.
     * @param {object} options - configuration options
     * @param {string} options.metaServiceUrl - URL of the SysMeta service
     * @param {localforage} [options.store] - optional localForage instance for
     * persistent caching. If not provided, a new instance will be created
     * @param {number} [options.ttlMs] - Time-To-Live for cached records in
     * milliseconds. Defaults to 24 hours (1 day).
     * @param {number} [options.maxChainHops] - Maximum number of hops in the
     * version chain to cache. Defaults to 200 hops.
     * @param {number} [options.maxCacheRecords] - Maximum number of in-memory cache records. Defaults to 5000.
     */
    constructor({
      metaServiceUrl,
      store = null,
      ttlMs = DEFAULT_TTL_MS,
      maxChainHops = DEFAULT_MAX_CHAIN_HOPS,
      maxCacheRecords = DEFAULT_MAX_CACHE_RECORDS,
    } = {}) {
      // metaServiceUrl may be undefined or invalid
      this.metaServiceUrl = NORMALIZE_METASERVICE_URL(metaServiceUrl);

      // TTL for cached records in milliseconds
      if (typeof ttlMs !== "number" || ttlMs &lt;= 0) {
        throw new Error("Invalid TTL provided to VersionTracker");
      }
      this.TTL_MS = ttlMs;

      // avoid unbounded chain growth
      if (typeof maxChainHops !== "number" || maxChainHops &lt;= 0) {
        throw new Error("Invalid maxChainHops provided to VersionTracker");
      }
      this.MAX_CHAIN_HOPS = maxChainHops;
      // limit in‑memory cache size (simple LRU)
      if (typeof maxCacheRecords !== "number" || maxCacheRecords &lt;= 0) {
        throw new Error("Invalid maxCacheRecords provided to VersionTracker");
      }
      this.MAX_CACHE_RECORDS = maxCacheRecords;

      // dedup in‑flight SysMeta fetches
      this.inFlight = new Map();

      // locks for concurrent fillVersionChain calls (e.g. when multiple getNth
      // calls are made for the same PID)
      this.locks = new Map();

      // in-memory cache
      this.cache = new Map();

      // store - persistent cache (IndexedDB | localStorage)
      if (store &amp;&amp; !IS_LOCAL_FORAGE(store)) {
        throw new Error(
          "Invalid store provided to VersionTracker. Must be a localforage instance.",
        );
      }
      // use a name based on the SysMeta service URL to avoid conflicts
      // with other instances that might use different URLs
      const storeName = `vt_${md5(this.metaServiceUrl)}`;
      this.store =
        store || localforage.createInstance({ name: storeName, storeName });
    }

    /**
     * Get the PID that is `offset` earlier or later in the version chain
     * relative to the given `pid`.
     * @param {string}  pid - the PID to start from
     * @param {number}  offset - the number of steps to move in the chain. 0 =
     * same PID, +n newer, -n older
     * @param {boolean} [ignoreEnd] Set to true to allow walking beyond cached
     * chain end (e.g. to re-check whether there's a newer version)
     * @param {boolean} [withMeta] - If true, return arrays of { pid,
     * sysMeta } instead of bare PIDs.
     * @returns {Promise&lt;VersionResult|string|null>} - resolves to the requested
     * PID at the given offset, or null if no such version exists. If `withMeta`
     * is true, resolves to an object with { pid, sysMeta }.
     */
    async getNth(pid, offset, ignoreEnd = false, withMeta = false) {
      // Validate inputs
      if (typeof pid !== "string" || !pid) {
        throw new Error("Invalid PID provided to getNth");
      }
      if (typeof offset !== "number") {
        throw new Error("Invalid offset provided to getNth");
      }
      if (Math.abs(offset) > this.MAX_CHAIN_HOPS) {
        throw new Error(
          `Offset ${offset} exceeds maximum chain hops limit of ${this.MAX_CHAIN_HOPS}`,
        );
      }

      // If offset is 0, just return the PID itself but make sure it's cached
      if (offset === 0) {
        const rec = await this.record(pid);
        if (withMeta) {
          if (!rec.sysMeta) await this.getSysMeta(pid);
          return { pid, sysMeta: rec.sysMeta };
        }
        return pid;
      }

      // Ensure the chain is long enough in the requested direction &amp; cache it
      const steps = Math.abs(offset);
      const forward = offset > 0;
      await this.fillVersionChain(pid, steps, forward, ignoreEnd);

      // Get the record from the cached chain and return the requested PID and sysMeta
      const rec = await this.record(pid);

      const list = forward ? rec.next : rec.prev;
      const targetPid = list[steps - 1] ?? null;
      if (!targetPid) return null;

      const targetRec = await this.record(targetPid);
      if (withMeta) {
        if (!targetRec.sysMeta) await this.getSysMeta(targetPid);
        return { pid: targetPid, sysMeta: targetRec.sysMeta };
      }
      return targetPid;
    }

    /**
     * Get the complete version chain for the given PID.
     * @param {string}  pid - PID to get the chain for
     * @param {boolean} [ignoreEnd] - Re‑probe past cached end flags
     * @param {boolean} [withMeta] - If true, return arrays of { pid,
     * sysMeta } instead of bare PIDs.
     * @returns {Promise&lt;VersionRecord>} - resolves to an object with `prev`,
     * `next`, `sysMeta`, `endPrev`, and `endNext` properties.
     */
    async getFullChain(pid, ignoreEnd = false, withMeta = false) {
      await this.fillVersionChain(pid, Infinity, true, ignoreEnd); // walk → newest
      await this.fillVersionChain(pid, Infinity, false, ignoreEnd); // walk → oldest
      const cached = this.cache.get(pid);
      const chain = {
        prev: cached.prev,
        next: cached.next,
        sysMeta: cached.sysMeta,
        endPrev: cached.endPrev,
        endNext: cached.endNext,
      };
      if (withMeta) {
        const withMetaMap = async (list) =>
          Promise.all(
            list.map(async (p) => {
              const r = await this.record(p);
              return { pid: p, sysMeta: r.sysMeta };
            }),
          );

        chain.prev = await withMetaMap(chain.prev);
        chain.next = await withMetaMap(chain.next);
      }
      return chain;
    }

    /**
     * Get the latest version PID in the version chain for the given PID.
     * @param {string} pid - the PID to get the latest version for
     * @param {boolean} [ignoreEnd] - If true, ignore end flags and continue
     * walking the chain even if it appears complete. This is useful for
     * re-checking if a newer version exists.
     * @param {boolean} [withMeta] - If true, the SysMeta will be fetched if not
     * already available in the cache.
     * @return {Promise&lt;string|VersionResult>} - resolves to the latest PID in
     * the chain, or an object with { pid, sysMeta } if `withMeta` is true. If
     * no versions are found, resolves to the original PID.
     */
    async getLatestVersion(pid, ignoreEnd = false, withMeta = false) {
      await this.fillVersionChain(pid, Infinity, true, ignoreEnd); // walk → newest
      const rec = await this.record(pid);
      const nextPids = rec.next;
      if (nextPids.length === 0) return pid;
      const latestPid = nextPids[nextPids.length - 1];
      if (withMeta) {
        const latestRec = await this.record(latestPid);
        if (!latestRec.sysMeta) await this.getSysMeta(latestPid);
        return { pid: latestPid, sysMeta: latestRec.sysMeta };
      }
      return latestPid;
    }

    /**
     * Refresh the version chain for the given PID by removing it from the cache
     * and re-fetching the full chain from the SysMeta service.
     * @param {string} pid - the PID to refresh
     * @returns {Promise&lt;object>} - resolves to the refreshed chain object
     */
    async refresh(pid) {
      await this.store.removeItem(pid);
      this.cache.delete(pid);
      await this.getFullChain(pid);
      return this.cache.get(pid);
    }

    /**
     * Clear the entire cache, including in-memory and persistent store.
     * @returns {Promise&lt;boolean>} - resolves to true if the cache was cleared
     */
    async clear() {
      await this.store.clear();
      this.cache.clear();
      this.inFlight.clear();
      this.locks.clear();
      // remove all listeners
      this.off();
      return true;
    }

    /**
     * Set the Time-To-Live (TTL) for cached records.
     * @param {number} ms - the TTL in milliseconds
     */
    setTTL(ms) {
      if (typeof ms !== "number" || ms &lt;= 0) {
        throw new Error("Invalid TTL provided to VersionTracker");
      }
      this.TTL_MS = Number(ms) || this.TTL_MS;
    }

    /**
     * Manually register that `newPid` obsoletes (comes after) `prevPid`. Useful
     * when an external editor just created a brand‑new revision so the chain
     * can be updated immediately without refetching SysMeta. If `sysMeta` for
     * the new PID is already available, pass it to avoid a network round‑trip;
     * otherwise the tracker will fetch it lazily when first requested.
     * @param {string} prevPid - the PID of the previous version
     * @param {string} newPid - the PID of the new version
     * @param {SysMeta} [sysMeta] - optional SysMeta object for the new version.
     */
    async addVersion(prevPid, newPid, sysMeta = null) {
      await this.fillVersionChain(prevPid, 1, true);
      await this.fillVersionChain(newPid, 1, false);

      const prevRec = await this.record(prevPid);
      const newRec = await this.record(newPid);

      // newPid must not be in the chain of prevPid
      if (prevRec.next.includes(newPid) || prevRec.prev.includes(newPid)) {
        throw new Error(
          `Cannot add version: ${newPid} is already in the chain of ${prevPid}`,
        );
      }

      // prevRec must be tip, newRec must be isolated
      const prevIsTip = prevRec.endNext &amp;&amp; prevRec.next.length === 0;
      const newIsIsolated =
        newRec.endPrev &amp;&amp; newRec.prev.length === 0 &amp;&amp; newRec.next.length === 0;
      if (!prevIsTip || !newIsIsolated) {
        let msg = `Cannot add version: ${newPid} as a new version of ${prevPid}`;
        if (!prevIsTip)
          msg += ` prevPid (${prevPid}) already has a newer version.`;
        if (!newIsIsolated)
          msg += ` newPid (${newPid}) already version history.`;
        throw new Error(msg);
      }

      // link the two
      prevRec.next[0] = newPid;
      prevRec.endNext = true;

      newRec.prev[0] = prevPid;
      newRec.endNext = true;
      if (sysMeta) newRec.sysMeta = sysMeta;

      await this.persist(prevPid, prevRec);
      await this.persist(newPid, newRec);

      this.notify(prevPid);
      this.notify(newPid);
    }

    /**
     * Notify that a specific the chain for a specific PID has been updated.
     * This is called internally after a new version is added or the chain is
     * updated.
     * @param {string} pid - the PID to notify about
     * @private
     */
    notify(pid) {
      const rec = this.cache.get(pid);
      this.trigger("update", rec);
      this.trigger(`update:${pid}`, rec);
    }

    /**
     * Ensure we have at least `stepsNeeded` hops cached in `direction` starting
     * from `startPid` (not counting the start itself).
     * @param {string} startPid - the PID to start from
     * @param {number} stepsNeeded - how many hops to fill in the chain
     * @param {boolean} forward - true to fill next versions, false for prev
     * @param {boolean} [ignoreEnd] - if true, ignore end flags and continue
     * filling the chain even if it appears complete.
     * @returns {Promise&lt;void>} - resolves when the chain is filled
     * @private
     */
    async fillVersionChain(startPid, stepsNeeded, forward, ignoreEnd = false) {
      const steps =
        stepsNeeded === Infinity ? this.MAX_CHAIN_HOPS : stepsNeeded;

      const rec = await this.record(startPid);
      const list = forward ? rec.next : rec.prev;
      const endFlag = forward ? "endNext" : "endPrev";

      if (ignoreEnd) {
        rec[endFlag] = false;
        rec.errors = []; // reset errors if we're ignoring end
        rec.sysMeta = null; // reset SysMeta to force re-fetch
        // re-save
        await this.persist(startPid, rec);
      }
      // --- simple per‑PID/dir lock to avoid concurrent mutation ---
      const lockKey = `${startPid}`;
      /* eslint-disable no-await-in-loop */
      while (this.locks.get(lockKey)) await this.locks.get(lockKey);
      let resolveLock;
      this.locks.set(
        lockKey,
        new Promise((r) => {
          resolveLock = r;
        }),
      );
      try {
        // already long enough
        if (list.length >= steps) {
          this.notify(startPid);
          return;
        }

        let currentPid = list.length > 0 ? list[list.length - 1] : startPid;

        // Walk until we fill `stepsNeeded` slots or hit chain end
        while (
          list.length &lt; steps &amp;&amp;
          currentPid &amp;&amp;
          (!rec[endFlag] || ignoreEnd)
        ) {
          let sysMeta;
          try {
            sysMeta = await this.getSysMeta(currentPid);
          } catch (e) {
            if (!rec.errors) rec.errors = [];
            rec.errors.push({
              pid: currentPid,
              error: e.message || "Unknown error fetching SysMeta",
              status: e.status ?? "UNKNOWN",
            });
            if (e.status === 401 || e.status === 403) {
              rec.unauthorized = true;
            }
            break; // stop if we can't fetch SysMeta
          }
          const adjacentPid = forward
            ? sysMeta?.data?.obsoletedBy
            : sysMeta?.data?.obsoletes;
          if (!adjacentPid) {
            rec[endFlag] = true; // mark end reached
            this.notify(startPid);
            break; // no more versions in this direction
          } else {
            list.push(adjacentPid);
            this.notify(startPid);

            // also populate the reverse link on the neighbour record
            const adjRec = await this.record(adjacentPid);
            const reverseList = forward ? adjRec.prev : adjRec.next;
            const idx = list.length - 1;
            if (reverseList[idx] !== startPid) {
              reverseList[idx] = startPid;
              await this.persist(adjacentPid, adjRec);
              this.notify(adjacentPid);
            }

            currentPid = adjacentPid;
          }
          /* eslint-enable no-await-in-loop */
        }
      } finally {
        await this.persist(startPid, rec);
        // always resolve the lock to allow other calls to proceed
        if (resolveLock) resolveLock();
        this.locks.delete(lockKey);
      }
    }

    /**
     * Ensure the user is authenticated and has a valid token.
     * @returns {Promise&lt;string>} - resolves to the user's token
     */
    static async getToken() {
      return MetacatUI.appUserModel.getTokenPromise();
    }

    /**
     * Get the SysMeta for a given PID. Prevents duplicate fetches for the same
     * PID and token by caching in-flight requests.
     * @param {string} pid - the PID to get SysMeta for
     * @returns {Promise&lt;SysMeta>} - resolves to the SysMeta object for the PID
     * @private
     */
    async getSysMeta(pid) {
      const token = await VersionTracker.getToken();
      const cacheKey = `${pid}:${token || ""}`;
      if (this.inFlight.has(cacheKey)) return this.inFlight.get(cacheKey);

      const fetchPromise = (async () => {
        const rec = await this.record(pid);
        if (rec.sysMeta) return rec.sysMeta;

        const sysMeta = new SysMeta({
          identifier: pid,
          metaServiceUrl: this.metaServiceUrl,
        });
        await sysMeta.fetch(token);
        rec.sysMeta = sysMeta;
        return rec.sysMeta;
      })();

      this.inFlight.set(cacheKey, fetchPromise);

      try {
        return await fetchPromise;
      } finally {
        this.inFlight.delete(cacheKey);
      }
    }

    /**
     * Get or create a record for the given PID, ensuring it is cached. If the
     * record is not found in the cache, it will be fetched from localForage. If
     * it doesn't exist in localForage, a new record will be created.
     * @param {string} pid - the PID to get the record for
     * @returns {Promise&lt;VersionRecord>} - resolves to the record object with
     * `next`, `prev`, `endNext`, `endPrev`, and `sysMeta` properties.
     * @private
     */
    async record(pid) {
      // First check the in-memory cache
      let rec = this.cache.get(pid);
      if (rec) return rec;

      // the rec obj will be updated with next/prev links if saved in
      // localForage
      rec = {
        next: [],
        prev: [],
        endNext: false,
        endPrev: false,
        sysMeta: null,
      };
      this.cache.set(pid, rec);
      // move to the end on (re)access
      const bump = () => {
        this.cache.delete(pid);
        this.cache.set(pid, rec);
      };
      bump();
      // Trim oldest if over limit
      while (this.cache.size > this.MAX_CACHE_RECORDS) {
        const oldestKey = this.cache.keys().next().value;
        this.cache.delete(oldestKey);
      }

      // async resurrect
      const saved = await this.load(pid);
      if (saved) {
        rec.next = (saved.next || []).filter(Boolean);
        rec.prev = (saved.prev || []).filter(Boolean);
        rec.endNext = !!saved.endNext;
        rec.endPrev = !!saved.endPrev;
        if (saved.sysMeta) {
          const sm = new SysMeta({
            identifier: pid,
            metaServiceUrl: this.metaServiceUrl,
          });
          sm.data = { identifier: pid, ...saved.sysMeta };
          sm.fetched = true; // mark as fetched to skip network
          rec.sysMeta = sm;
        }
      }
      return rec;
    }

    /**
     * Persist the record for the given PID to localForage. This will store the
     * next/prev links, end flags, and lean SysMeta data.
     * @param {string} pid - the PID to persist
     * @param {VersionRecord} rec - the record to persist
     * @returns {Promise&lt;void>} - resolves when the record is persisted
     * @private
     */
    async persist(pid, rec) {
      // Extract lean SysMeta data if available
      let leanMeta = null;

      if (rec.sysMeta &amp;&amp; rec.sysMeta.data) {
        leanMeta = {};
        PERSISTED_SYS_META_FIELDS.forEach((k) => {
          if (rec.sysMeta.data[k] !== undefined)
            leanMeta[k] = rec.sysMeta.data[k];
        });
      }
      await this.store.setItem(pid, {
        next: rec.next,
        prev: rec.prev,
        endNext: rec.endNext,
        endPrev: rec.endPrev,
        sysMeta: leanMeta,
        ts: Date.now(),
      });
    }

    /**
     * Load a record for the given PID from localForage. If the record is older
     * than the TTL, it will be removed from the store and null will be
     * returned.
     * @param {string} pid - the PID to load
     * @returns {Promise&lt;VersionRecord|null>} resolves to the record object or
     * null if not found or expired
     * @private
     */
    async load(pid) {
      const saved = await this.store.getItem(pid);
      if (!saved) return null;
      if (Date.now() - saved.ts > this.TTL_MS) {
        await this.store.removeItem(pid);
        return null;
      }
      return saved;
    }
  }

  // Allow the class to trigger Backbone events
  Object.assign(VersionTracker.prototype, Backbone.Events);

  // static map &amp; accessor for singleton instances
  VersionTracker.instances = new Map();

  VersionTracker.get = function get(metaServiceUrl) {
    const msUrl = NORMALIZE_METASERVICE_URL(metaServiceUrl);

    if (!VersionTracker.instances.has(msUrl)) {
      VersionTracker.instances.set(msUrl, new VersionTracker({ msUrl }));
    }
    return VersionTracker.instances.get(msUrl);
  };

  return VersionTracker;
});
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
