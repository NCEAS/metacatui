<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>MetacatUI Dev Docs: Source: src/js/views/metadata/EML211EditorView.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="/metacatui/assets/css/styles.css">
    <link type="text/css" rel="stylesheet" href="styles/style.css">
</head>

<body>

<nav id="nav">
    <a href="/">
      <div class="logo">
<svg class="cat" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="cat" class="svg-inline--fa fa-cat fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M290.59 192c-20.18 0-106.82 1.98-162.59 85.95V192c0-52.94-43.06-96-96-96-17.67 0-32 14.33-32 32s14.33 32 32 32c17.64 0 32 14.36 32 32v256c0 35.3 28.7 64 64 64h176c8.84 0 16-7.16 16-16v-16c0-17.67-14.33-32-32-32h-32l128-96v144c0 8.84 7.16 16 16 16h32c8.84 0 16-7.16 16-16V289.86c-10.29 2.67-20.89 4.54-32 4.54-61.81 0-113.52-44.05-125.41-102.4zM448 96h-64l-64-64v134.4c0 53.02 42.98 96 96 96s96-42.98 96-96V32l-64 64zm-72 80c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16zm80 0c-8.84 0-16-7.16-16-16s7.16-16 16-16 16 7.16 16 16-7.16 16-16 16z"></path></svg>

<svg width="459px" height="53px" viewBox="0 0 459 53" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <g id="metacatui" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <path d="M16.492,52 C17.212,52 17.812,51.748 18.292,51.244 C18.772,50.74 19.012,50.128 19.012,49.408 L19.012,49.408 L18.94,22.912 L30.82,37.816 C31.204,38.344 31.72,38.764 32.368,39.076 C33.016,39.388 33.7,39.544 34.42,39.544 C35.908,39.544 37.132,38.896 38.092,37.6 L38.092,37.6 L49.684,22.912 L49.684,49.408 C49.684,50.128 49.96,50.74 50.512,51.244 C51.064,51.748 51.7,52 52.42,52 L52.42,52 L62.068,52 C62.788,52 63.388,51.748 63.868,51.244 C64.348,50.74 64.588,50.128 64.588,49.408 L64.588,49.408 L64.588,4.12 C64.588,3.448 64.336,2.86 63.832,2.356 C63.328,1.852 62.74,1.6 62.068,1.6 L62.068,1.6 L52.348,1.6 C51.388,1.6 50.56,1.648 49.864,1.744 C49.168,1.84 48.532,2.152 47.956,2.68 L47.956,2.68 L33.916,17.296 L20.524,2.608 C20.332,2.368 19.972,2.14 19.444,1.924 C18.916,1.708 18.412,1.6 17.932,1.6 L17.932,1.6 L6.772,1.6 C6.052,1.6 5.44,1.852 4.936,2.356 C4.432,2.86 4.18,3.448 4.18,4.12 L4.18,4.12 L4.18,49.408 C4.18,50.08 4.432,50.68 4.936,51.208 C5.44,51.736 6.052,52 6.772,52 L6.772,52 L16.492,52 Z M110.74,52 C111.556,52 112.264,51.676 112.864,51.028 C113.464,50.38 113.764,49.624 113.764,48.76 L113.764,48.76 L113.764,42.568 C113.764,41.608 113.464,40.828 112.864,40.228 C112.264,39.628 111.556,39.328 110.74,39.328 L110.74,39.328 L89.428,39.328 L89.428,32.92 L109.732,32.92 C110.5,32.92 111.184,32.596 111.784,31.948 C112.384,31.3 112.684,30.568 112.684,29.752 L112.684,29.752 L112.684,23.488 C112.684,22.576 112.384,21.82 111.784,21.22 C111.184,20.62 110.5,20.32 109.732,20.32 L109.732,20.32 L89.428,20.32 L89.428,14.488 L110.74,14.488 C111.508,14.488 112.204,14.164 112.828,13.516 C113.452,12.868 113.764,12.136 113.764,11.32 L113.764,11.32 L113.764,5.056 C113.764,4.144 113.464,3.388 112.864,2.788 C112.264,2.188 111.556,1.888 110.74,1.888 L110.74,1.888 L76.756,1.888 C75.94,1.888 75.232,2.188 74.632,2.788 C74.032,3.388 73.732,4.144 73.732,5.056 L73.732,5.056 L73.732,48.76 C73.732,49.624 74.032,50.38 74.632,51.028 C75.232,51.676 75.94,52 76.756,52 L76.756,52 L110.74,52 Z M147.604,52 C148.42,52 149.104,51.688 149.656,51.064 C150.208,50.44 150.484,49.672 150.484,48.76 L150.484,48.76 L150.484,16.216 L161.86,16.216 C162.676,16.216 163.396,15.904 164.02,15.28 C164.644,14.656 164.956,13.936 164.956,13.12 L164.956,13.12 L164.956,4.768 C164.956,4 164.644,3.316 164.02,2.716 C163.396,2.116 162.676,1.816 161.86,1.816 L161.86,1.816 L124.132,1.816 C123.22,1.816 122.464,2.104 121.864,2.68 C121.264,3.256 120.964,3.952 120.964,4.768 L120.964,4.768 L120.964,13.12 C120.964,13.936 121.264,14.656 121.864,15.28 C122.464,15.904 123.22,16.216 124.132,16.216 L124.132,16.216 L135.652,16.216 L135.148,48.832 C135.148,49.744 135.424,50.5 135.976,51.1 C136.528,51.7 137.212,52 138.028,52 L138.028,52 L147.604,52 Z M175.828,52 C176.836,52 177.676,51.82 178.348,51.46 C179.02,51.1 179.452,50.584 179.644,49.912 L179.644,49.912 L181.876,42.712 L197.932,42.712 L200.164,49.912 C200.356,50.584 200.8,51.1 201.496,51.46 C202.192,51.82 203.044,52 204.052,52 L204.052,52 L213.916,52 C215.836,51.712 216.796,50.704 216.796,48.976 C216.796,48.304 216.676,47.596 216.436,46.852 C216.196,46.108 216.052,45.616 216.004,45.376 L216.004,45.376 L199.876,4.84 C199.588,3.976 199.036,3.232 198.22,2.608 C197.404,1.984 196.372,1.648 195.124,1.6 L195.124,1.6 L184.756,1.6 C183.604,1.648 182.608,1.948 181.768,2.5 C180.928,3.052 180.292,3.832 179.86,4.84 L179.86,4.84 L163.876,45.376 C163.828,45.472 163.672,45.916 163.408,46.708 C163.144,47.5 163.012,48.304 163.012,49.12 C163.012,50.752 163.948,51.712 165.82,52 L165.82,52 L175.828,52 Z M195.34,30.544 L184.036,30.544 L189.652,13.624 L195.34,30.544 Z M245.38,53.08 C250.612,53.08 255.652,51.544 260.5,48.472 C261.22,47.944 261.58,47.296 261.58,46.528 C261.58,45.808 261.292,45.16 260.716,44.584 L260.716,44.584 L252.796,36.808 C252.364,36.376 251.836,36.16 251.212,36.16 C250.78,36.16 250.372,36.256 249.988,36.448 C248.356,37.12 246.796,37.456 245.308,37.456 C243.244,37.456 241.348,36.952 239.62,35.944 C237.892,34.936 236.512,33.58 235.48,31.876 C234.448,30.172 233.932,28.336 233.932,26.368 C233.932,24.352 234.436,22.504 235.444,20.824 C236.452,19.144 237.832,17.812 239.584,16.828 C241.336,15.844 243.244,15.352 245.308,15.352 C246.892,15.352 248.332,15.64 249.628,16.216 C250.012,16.408 250.444,16.504 250.924,16.504 C251.548,16.504 252.1,16.264 252.58,15.784 L252.58,15.784 L259.636,8.008 C260.164,7.384 260.428,6.76 260.428,6.136 C260.428,5.224 259.996,4.528 259.132,4.048 C254.86,1.552 250.276,0.304 245.38,0.304 C240.532,0.304 236.032,1.492 231.88,3.868 C227.728,6.244 224.44,9.448 222.016,13.48 C219.592,17.512 218.38,21.904 218.38,26.656 C218.38,31.408 219.592,35.812 222.016,39.868 C224.44,43.924 227.728,47.14 231.88,49.516 C236.032,51.892 240.532,53.08 245.38,53.08 Z M279.796,52 C280.804,52 281.644,51.82 282.316,51.46 C282.988,51.1 283.42,50.584 283.612,49.912 L283.612,49.912 L285.844,42.712 L301.9,42.712 L304.132,49.912 C304.324,50.584 304.768,51.1 305.464,51.46 C306.16,51.82 307.012,52 308.02,52 L308.02,52 L317.884,52 C319.804,51.712 320.764,50.704 320.764,48.976 C320.764,48.304 320.644,47.596 320.404,46.852 C320.164,46.108 320.02,45.616 319.972,45.376 L319.972,45.376 L303.844,4.84 C303.556,3.976 303.004,3.232 302.188,2.608 C301.372,1.984 300.34,1.648 299.092,1.6 L299.092,1.6 L288.724,1.6 C287.572,1.648 286.576,1.948 285.736,2.5 C284.896,3.052 284.26,3.832 283.828,4.84 L283.828,4.84 L267.844,45.376 C267.796,45.472 267.64,45.916 267.376,46.708 C267.112,47.5 266.98,48.304 266.98,49.12 C266.98,50.752 267.916,51.712 269.788,52 L269.788,52 L279.796,52 Z M299.308,30.544 L288.004,30.544 L293.62,13.624 L299.308,30.544 Z M352.588,52 C353.404,52 354.088,51.688 354.64,51.064 C355.192,50.44 355.468,49.672 355.468,48.76 L355.468,48.76 L355.468,16.216 L366.844,16.216 C367.66,16.216 368.38,15.904 369.004,15.28 C369.628,14.656 369.94,13.936 369.94,13.12 L369.94,13.12 L369.94,4.768 C369.94,4 369.628,3.316 369.004,2.716 C368.38,2.116 367.66,1.816 366.844,1.816 L366.844,1.816 L329.116,1.816 C328.204,1.816 327.448,2.104 326.848,2.68 C326.248,3.256 325.948,3.952 325.948,4.768 L325.948,4.768 L325.948,13.12 C325.948,13.936 326.248,14.656 326.848,15.28 C327.448,15.904 328.204,16.216 329.116,16.216 L329.116,16.216 L340.636,16.216 L340.132,48.832 C340.132,49.744 340.408,50.5 340.96,51.1 C341.512,51.7 342.196,52 343.012,52 L343.012,52 L352.588,52 Z M402.052,52.792 C408.1,52.792 412.912,51.628 416.488,49.3 C420.064,46.972 422.536,44.068 423.904,40.588 C425.272,37.108 425.932,33.424 425.884,29.536 C425.884,29.5309474 425.883967,29.5237673 425.8839,29.5144598 L425.883102,29.4330859 C425.879911,29.1480111 425.868211,28.3183158 425.848,26.944 C425.8294,25.6792 425.818008,22.91524 425.813823,18.65212 L425.813103,17.80828 C425.812997,17.66452 425.8129,17.5192 425.81281,17.37232 L425.812,3.904 C425.86,3.184 425.632,2.62 425.128,2.212 C424.624,1.804 423.916,1.6 423.004,1.6 L423.004,1.6 L413.428,1.6 C412.612,1.6 411.904,1.828 411.304,2.284 C410.704,2.74 410.404,3.28 410.404,3.904 L410.404,3.904 L410.26,27.808 C410.26,34.144 407.476,37.312 401.908,37.312 C399.076,37.312 396.832,36.412 395.176,34.612 C393.52,32.812 392.668,30.352 392.62,27.232 L392.62,27.232 L392.332,3.76 C392.332,3.088 392.068,2.56 391.54,2.176 C391.012,1.792 390.268,1.6 389.308,1.6 L389.308,1.6 L379.876,1.6 C378.244,1.6 377.428,2.32 377.428,3.76 L377.428,3.76 L377.5,28.816 C377.5,33.04 378.376,36.964 380.128,40.588 C381.88,44.212 384.592,47.152 388.264,49.408 C391.936,51.664 396.532,52.792 402.052,52.792 Z M449.284,52.144 C450.148,52.144 450.88,51.844 451.48,51.244 C452.08,50.644 452.38,49.84 452.38,48.832 L452.38,48.832 L452.38,4.912 C452.38,4 452.08,3.22 451.48,2.572 C450.88,1.924 450.148,1.6 449.284,1.6 L449.284,1.6 L439.42,1.6 C438.46,1.6 437.692,1.924 437.116,2.572 C436.54,3.22 436.252,4 436.252,4.912 L436.252,4.912 L436.252,48.832 C436.252,49.84 436.54,50.644 437.116,51.244 C437.692,51.844 438.46,52.144 439.42,52.144 L439.42,52.144 L449.284,52.144 Z" id="metacatui" fill="#FCBF49" fill-rule="nonzero"></path>
    </g>
</svg>
</logo>

    </a>
    <h3>Namespaces</h3><ul><li><a href="AppConfig.html">AppConfig</a></li><li><a href="MapConfig.html">MapConfig</a></li><li><a href="MetacatUI.html">MetacatUI</a></li><li><a href="Utilities.html">Utilities</a></li></ul><h3>Classes</h3><ul><li class='category-heading' data-category='Collections'>Collections</li><li><a href="AccessPolicy.html">AccessPolicy</a></li><li><a href="Citations.html">Citations</a></li><li><a href="DataPackage.html">DataPackage</a></li><li><a href="Filters.html">Filters</a></li><li><a href="ObjectFormats.html">ObjectFormats</a></li><li><a href="ProjectList.html">ProjectList</a></li><li><a href="QualityReport.html">QualityReport</a></li><li><a href="SolrResults.html">SolrResults</a></li><li><a href="Units.html">Units</a></li><li><a href="UserGroup.html">UserGroup</a></li><li class='category-heading' data-category='Collections/Bookkeeper'>Collections/Bookkeeper</li><li><a href="Quotas.html">Quotas</a></li><li><a href="Usages.html">Usages</a></li><li class='category-heading' data-category='Collections/Maps'>Collections/Maps</li><li><a href="AssetColors.html">AssetColors</a></li><li><a href="Features.html">Features</a></li><li><a href="MapAssets.html">MapAssets</a></li><li><a href="VectorFilters.html">VectorFilters</a></li><li class='category-heading' data-category='Collections/Metadata/EML'>Collections/Metadata/EML</li><li><a href="EMLAnnotations.html">EMLAnnotations</a></li><li class='category-heading' data-category='Collections/QueryFields'>Collections/QueryFields</li><li><a href="QueryFields.html">QueryFields</a></li><li class='category-heading' data-category='Models'>Models</li><li><a href="AccessRule.html">AccessRule</a></li><li><a href="AppModel.html">AppModel</a></li><li><a href="CitationModel.html">CitationModel</a></li><li><a href="CollectionModel.html">CollectionModel</a></li><li><a href="DataONEObject.html">DataONEObject</a></li><li><a href="LookupModel.html">LookupModel</a></li><li><a href="Map.html">Map</a></li><li><a href="Metrics.html">Metrics</a></li><li><a href="QualityCheck.html">QualityCheck</a></li><li><a href="Search.html">Search</a></li><li><a href="SolrResult.html">SolrResult</a></li><li><a href="Stats.html">Stats</a></li><li class='category-heading' data-category='Models/Bookkeeper'>Models/Bookkeeper</li><li><a href="Quota.html">Quota</a></li><li><a href="Subscription.html">Subscription</a></li><li><a href="Usage.html">Usage</a></li><li class='category-heading' data-category='Models/Connectors'>Models/Connectors</li><li><a href="FiltersSearchConnector.html">FiltersSearchConnector</a></li><li><a href="GeohashSearchConnector.html">GeohashSearchConnector</a></li><li class='category-heading' data-category='Models/Filters'>Models/Filters</li><li><a href="BooleanFilter.html">BooleanFilter</a></li><li><a href="ChoiceFilter.html">ChoiceFilter</a></li><li><a href="DateFilter.html">DateFilter</a></li><li><a href="Filter.html">Filter</a></li><li><a href="FilterGroup.html">FilterGroup</a></li><li><a href="NumericFilter.html">NumericFilter</a></li><li><a href="SpatialFilter.html">SpatialFilter</a></li><li><a href="ToggleFilter.html">ToggleFilter</a></li><li class='category-heading' data-category='Models/Formats'>Models/Formats</li><li><a href="ObjectFormat.html">ObjectFormat</a></li><li class='category-heading' data-category='Models/Maps'>Models/Maps</li><li><a href="AssetColor.html">AssetColor</a></li><li><a href="AssetColorPalette.html">AssetColorPalette</a></li><li><a href="Feature.html">Feature</a></li><li><a href="MapModel.html">MapModel</a></li><li><a href="VectorFilter.html">VectorFilter</a></li><li class='category-heading' data-category='Models/Maps/Assets'>Models/Maps/Assets</li><li><a href="Cesium3DTileset.html">Cesium3DTileset</a></li><li><a href="CesiumGeohash.html">CesiumGeohash</a></li><li><a href="CesiumImagery.html">CesiumImagery</a></li><li><a href="CesiumTerrain.html">CesiumTerrain</a></li><li><a href="CesiumVectorData.html">CesiumVectorData</a></li><li><a href="MapAsset.html">MapAsset</a></li><li class='category-heading' data-category='Models/Metadata'>Models/Metadata</li><li><a href="ScienceMetadata.html">ScienceMetadata</a></li><li class='category-heading' data-category='Models/Metadata/EML'>Models/Metadata/EML</li><li><a href="EMLMethodStep.html">EMLMethodStep</a></li><li><a href="EMLSpecializedText.html">EMLSpecializedText</a></li><li class='category-heading' data-category='Models/Metadata/EML211'>Models/Metadata/EML211</li><li><a href="EML211.html">EML211</a></li><li><a href="EMLAnnotation.html">EMLAnnotation</a></li><li><a href="EMLAttribute.html">EMLAttribute</a></li><li><a href="EMLDataTable.html">EMLDataTable</a></li><li><a href="EMLEntity.html">EMLEntity</a></li><li><a href="EMLGeoCoverage.html">EMLGeoCoverage</a></li><li><a href="EMLMeasurementScale.html">EMLMeasurementScale</a></li><li><a href="EMLMethods.html">EMLMethods</a></li><li><a href="EMLNonNumericDomain.html">EMLNonNumericDomain</a></li><li><a href="EMLNumericDomain.html">EMLNumericDomain</a></li><li><a href="EMLOtherEntity.html">EMLOtherEntity</a></li><li><a href="EMLParty.html">EMLParty</a></li><li><a href="EMLTemporalCoverage.html">EMLTemporalCoverage</a></li><li><a href="EMLText211.html">EMLText211</a></li><li><a href="EMLUnit.html">EMLUnit</a></li><li class='category-heading' data-category='Models/Metadata/EML220'>Models/Metadata/EML220</li><li><a href="EMLText.html">EMLText</a></li><li class='category-heading' data-category='Models/Portals'>Models/Portals</li><li><a href="PortalImage.html">PortalImage</a></li><li><a href="PortalModel.html">PortalModel</a></li><li><a href="PortalSectionModel.html">PortalSectionModel</a></li><li class='category-heading' data-category='Models/Projects'>Models/Projects</li><li><a href="Project.html">Project</a></li><li class='category-heading' data-category='Models/QueryFields'>Models/QueryFields</li><li><a href="QueryField.html">QueryField</a></li><li class='category-heading' data-category='Router'>Router</li><li><a href="UIRouter.html">UIRouter</a></li><li class='category-heading' data-category='Views'>Views</li><li><a href="AccessPolicyView.html">AccessPolicyView</a></li><li><a href="AccessRuleView.html">AccessRuleView</a></li><li><a href="AnnotationView.html">AnnotationView</a></li><li><a href="AppView.html">AppView</a></li><li><a href="CatalogSearchView.html">CatalogSearchView</a></li><li><a href="CitationHeaderView.html">CitationHeaderView</a></li><li><a href="CitationListView.html">CitationListView</a></li><li><a href="CitationModalView.html">CitationModalView</a></li><li><a href="CitationView.html">CitationView</a></li><li><a href="ColorPaletteView.html">ColorPaletteView</a></li><li><a href="DataCatalogViewWithFilters.html">DataCatalogViewWithFilters</a></li><li><a href="DataItemView.html">DataItemView</a></li><li><a href="DataPackageView.html">DataPackageView</a></li><li><a href="DraftsView.html">DraftsView</a></li><li><a href="EditCollectionView.html">EditCollectionView</a></li><li><a href="EditorView.html">EditorView</a></li><li><a href="FooterView.html">FooterView</a></li><li><a href="GroupListView.html">GroupListView</a></li><li><a href="ImageUploaderView.html">ImageUploaderView</a></li><li><a href="MarkdownEditorView.html">MarkdownEditorView</a></li><li><a href="MarkdownView.html">MarkdownView</a></li><li><a href="MdqRunView.html">MdqRunView</a></li><li><a href="MetadataView.html">MetadataView</a></li><li><a href="MetricModalView.html">MetricModalView</a></li><li><a href="MetricView.html">MetricView</a></li><li><a href="MetricsChartView.html">MetricsChartView</a></li><li><a href="NavbarView.html">NavbarView</a></li><li><a href="RegisterCitationView.html">RegisterCitationView</a></li><li><a href="SignInView.html">SignInView</a></li><li><a href="TOCView.html">TOCView</a></li><li><a href="TableEditorView.html">TableEditorView</a></li><li><a href="UserGroupView.html">UserGroupView</a></li><li><a href="UserView.html">UserView</a></li><li class='category-heading' data-category='Views/Filters'>Views/Filters</li><li><a href="BooleanFilterView.html">BooleanFilterView</a></li><li><a href="ChoiceFilterView.html">ChoiceFilterView</a></li><li><a href="DateFilterView.html">DateFilterView</a></li><li><a href="FilterEditorView.html">FilterEditorView</a></li><li><a href="FilterGroupView.html">FilterGroupView</a></li><li><a href="FilterGroupsView.html">FilterGroupsView</a></li><li><a href="FilterView.html">FilterView</a></li><li><a href="NumericFilterView.html">NumericFilterView</a></li><li><a href="SemanticFilterView.html">SemanticFilterView</a></li><li><a href="ToggleFilterView.html">ToggleFilterView</a></li><li class='category-heading' data-category='Views/Maps'>Views/Maps</li><li><a href="CesiumGeohashes.html">CesiumGeohashes</a></li><li><a href="CesiumWidgetView.html">CesiumWidgetView</a></li><li><a href="FeatureInfoView.html">FeatureInfoView</a></li><li><a href="LayerDetailView.html">LayerDetailView</a></li><li><a href="LayerDetailsView.html">LayerDetailsView</a></li><li><a href="LayerInfoView.html">LayerInfoView</a></li><li><a href="LayerItemView.html">LayerItemView</a></li><li><a href="LayerListView.html">LayerListView</a></li><li><a href="LayerNavigationView.html">LayerNavigationView</a></li><li><a href="LayerOpacityView.html">LayerOpacityView</a></li><li><a href="LegendView.html">LegendView</a></li><li><a href="MapView.html">MapView</a></li><li><a href="ScaleBarView.html">ScaleBarView</a></li><li><a href="ToolbarView.html">ToolbarView</a></li><li class='category-heading' data-category='Views/Metadata'>Views/Metadata</li><li><a href="EML211EditorView.html">EML211EditorView</a></li><li><a href="EMLAttributeView.html">EMLAttributeView</a></li><li><a href="EMLEntityView.html">EMLEntityView</a></li><li><a href="EMLMeasurementScaleView.html">EMLMeasurementScaleView</a></li><li><a href="EMLMeasurementTypeView.html">EMLMeasurementTypeView</a></li><li><a href="EMLMethodsView.html">EMLMethodsView</a></li><li><a href="EMLOtherEntityView.html">EMLOtherEntityView</a></li><li><a href="EMLPartyView.html">EMLPartyView</a></li><li><a href="EMLTempCoverageView.html">EMLTempCoverageView</a></li><li><a href="EMLView.html">EMLView</a></li><li><a href="EMlGeoCoverageView_.html">EMlGeoCoverageView</a></li><li><a href="ScienceMetadataView.html">ScienceMetadataView</a></li><li class='category-heading' data-category='Views/Portals'>Views/Portals</li><li><a href="PortalDataView.html">PortalDataView</a></li><li><a href="PortalHeaderView.html">PortalHeaderView</a></li><li><a href="PortalListView.html">PortalListView</a></li><li><a href="PortalLogosView.html">PortalLogosView</a></li><li><a href="PortalMembersView.html">PortalMembersView</a></li><li><a href="PortalSectionView.html">PortalSectionView</a></li><li><a href="PortalUsagesView.html">PortalUsagesView</a></li><li><a href="PortalView.html">PortalView</a></li><li><a href="PortalVisualizationsView.html">PortalVisualizationsView</a></li><li><a href="PortalsSearchView.html">PortalsSearchView</a></li><li class='category-heading' data-category='Views/Portals/Editor'>Views/Portals/Editor</li><li><a href="PortEditorDataView.html">PortEditorDataView</a></li><li><a href="PortEditorImageView.html">PortEditorImageView</a></li><li><a href="PortEditorLogosView.html">PortEditorLogosView</a></li><li><a href="PortEditorMdSectionView.html">PortEditorMdSectionView</a></li><li><a href="PortEditorSectionView.html">PortEditorSectionView</a></li><li><a href="PortEditorSectionsView.html">PortEditorSectionsView</a></li><li><a href="PortEditorSettingsView.html">PortEditorSettingsView</a></li><li><a href="PortalEditorView.html">PortalEditorView</a></li><li class='category-heading' data-category='Views/Projects'>Views/Projects</li><li><a href="ProjectView.html">ProjectView</a></li><li class='category-heading' data-category='Views/QueryBuilder'>Views/QueryBuilder</li><li><a href="QueryBuilderView.html">QueryBuilderView</a></li><li><a href="QueryRuleView.html">QueryRuleView</a></li><li class='category-heading' data-category='Views/Search'>Views/Search</li><li><a href="SearchResultsPagerView.html">SearchResultsPagerView</a></li><li><a href="SearchResultsView.html">SearchResultsView</a></li><li><a href="SorterView.html">SorterView</a></li><li class='category-heading' data-category='Views/SearchSelect'>Views/SearchSelect</li><li><a href="AccountSelectView.html">AccountSelectView</a></li><li><a href="AnnotationFilter.html">AnnotationFilter</a></li><li><a href="NodeSelect.html">NodeSelect</a></li><li><a href="ObjectFormatSelect.html">ObjectFormatSelect</a></li><li><a href="QueryFieldSelectView.html">QueryFieldSelectView</a></li><li><a href="SearchableSelectView.html">SearchableSelectView</a></li><li class='category-heading' data-category='Deprecated'>Deprecated</li><li><a href="AnnotatorView.html">AnnotatorView</a></li><li><a href="ExternalView.html">ExternalView</a></li><li><a href="LogsSearch.html">LogsSearch</a></li></ul><h3>Global</h3><ul><li><a href="global.html#appConfigPath">appConfigPath</a></li></ul>
</nav>

<div id="main">

    <h1 class="page-title">Source: src/js/views/metadata/EML211EditorView.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/* global define */
define(['underscore',
  'jquery',
  'backbone',
  'localforage',
  'collections/DataPackage',
  'models/metadata/eml211/EML211',
  'models/metadata/eml211/EMLOtherEntity',
  'models/metadata/ScienceMetadata',
  'views/EditorView',
  'views/CitationView',
  'views/DataPackageView',
  'views/metadata/EML211View',
  'views/metadata/EMLEntityView',
  'views/SignInView',
  'text!templates/editor.html',
  'collections/ObjectFormats',
  'text!templates/editorSubmitMessage.html'],
  function (_, $, Backbone, LocalForage,
    DataPackage, EML, EMLOtherEntity, ScienceMetadata,
    EditorView, CitationView, DataPackageView, EMLView, EMLEntityView, SignInView,
    EditorTemplate, ObjectFormats, EditorSubmitMessageTemplate) {

    /**
    * @class EML211EditorView
    * @classdesc A view of a form for creating and editing EML 2.1.1 documents
    * @classcategory Views/Metadata
    * @name EML211EditorView
    * @extends EditorView
    * @constructs
    */
    var EML211EditorView = EditorView.extend(
      /** @lends EML211EditorView.prototype */{

        type: "EML211Editor",

        /* The initial editor layout */
        template: _.template(EditorTemplate),
        editorSubmitMessageTemplate: _.template(EditorSubmitMessageTemplate),

        /**
        * The text to use in the editor submit button
        * @type {string}
        */
        submitButtonText: MetacatUI.appModel.get("editorSaveButtonText"),

        /**
        * The events this view will listen to and the associated function to call.
        * This view will inherit events from the parent class, EditorView.
        * @type {Object}
        */
        events: _.extend(EditorView.prototype.events, {
          "change": "saveDraft",
          "click .data-package-item .edit": "showEntity"
        }),

        /**
        The identifier of the root package EML being rendered
        * @type {string}
        */
        pid: null,

        /**
        * A list of the subviews of the editor
        * @type {Backbone.Views[]}
        */
        subviews: [],

        /**
        * The data package view
        * @type {DataPackageView}
        */
        dataPackageView: null,

        /**
        * Initialize a new EML211EditorView - called post constructor
        */
        initialize: function (options) {

          // Ensure the object formats are cached for the editor's use
          if (typeof MetacatUI.objectFormats === "undefined") {
            MetacatUI.objectFormats = new ObjectFormats();
            MetacatUI.objectFormats.fetch();

          }
          return this;
        },

        /**
        * Create a new EML model for this view
        */
        createModel: function () {

          //If no pid is given, create a new EML model
          if (!this.pid)
            var model = new EML({ 'synced': true });
          //Otherwise create a generic metadata model until we find out the formatId
          else
            var model = new ScienceMetadata({ id: this.pid });

          // Once the ScienceMetadata is populated, populate the associated package
          this.model = model;

          //Listen for the replace event on this model
          var view = this;
          this.listenTo(this.model, "replace", function (newModel) {
            if (view.model.get("id") == newModel.get("id")) {
              view.model = newModel;
              view.setListeners();
            }
          });

          this.setListeners();
        },

        /**
        * Render the view
        */
        render: function () {

          var view = this;

          //Execute the superclass render() function, which will add some basic Editor functionality
          EditorView.prototype.render.call(this);

          MetacatUI.appModel.set('headerType', 'default');

          //Empty the view element first
          this.$el.empty();

          //Inert the basic template on the page
          this.$el.html(this.template({
            loading: MetacatUI.appView.loadingTemplate({ msg: "Starting the editor..." }),
            submitButtonText: this.submitButtonText
          }));

          //If we don't have a model at this point, create one
          if (!this.model) this.createModel();

          // Before rendering the editor, we must:
          // 1. Make sure the user is signed in
          // 2. Fetch the metadata
          // 3. Use the metadata to identify and then fetch the resource map
          // 4. Make sure the user has write permission on the metadata
          // 5. Make sure the user has write permission on the resource map

          // As soon as we have all of the metadata information (STEP 2 complete)...
          this.listenToOnce(this.model, "sync", function () {

            // Skip the remaining steps the metadata doesn't exist.
            if (this.model.get("notFound") == true) {
              this.showNotFound();
              return
            }

            // STEP 3
            // Listen for a trigger from the getDataPackage function that indicates
            // The data package (resource map) has been retrieved.
            this.listenToOnce(this, "dataPackageFound", function () {

              var resourceMap = MetacatUI.rootDataPackage.packageModel;

              // STEP 5
              // Once we have the resource map, then check that the user is authorized to edit this package.
              this.listenToOnce(resourceMap, "change:isAuthorized_write", function (model, authorization) {
                // Render if authorized (will show not authorized if not)
                this.renderEditorComponents();
              });
              // No need to check authorization for a new resource map
              if (resourceMap.isNew()) {
                resourceMap.set("isAuthorized_write", true);
              } else {
                resourceMap.checkAuthority("write");
                this.updateLoadingText("Loading metadata...");
              }

            });

            this.getDataPackage();

            // STEP 4
            // Check the authority of this user to edit the metadata
            this.listenToOnce(this.model, "change:isAuthorized_write", function (model, authorization) {
              // Render if authorized (will show not authorized if not)
              this.renderEditorComponents();
            });
            // If the model is new, no need to check for authorization.
            if (this.model.isNew()) {
              this.model.set("isAuthorized_write", true);
            } else {
              this.model.checkAuthority("write");
              this.updateLoadingText("Checking authorization...");
            }
          });

          // STEP 1
          // Check that the user is signed in
          var afterAccountChecked = function () {
            if (MetacatUI.appUserModel.get("loggedIn") == false) {
              // If they are not signed in, then show the sign-in view
              view.showSignIn();
            } else {
              // STEP 2
              // If signed in, then fetch model
              view.fetchModel();
            }
          }
          // If we've already checked the user account
          if (MetacatUI.appUserModel.get("checked")) {
            afterAccountChecked();
          }
          // If we haven't checked for authentication yet,
          // wait until the user info is loaded before we request the Metadata
          else {
            this.listenToOnce(MetacatUI.appUserModel, "change:checked", function () {
              afterAccountChecked();
            });
          }

          // When the user mistakenly drops a file into an area in the window
          // that isn't a proper drop-target, prevent navigating away from the
          // page. Without this, the user will lose their progress in the
          // editor.
          window.addEventListener("dragover", function (e) {
            e = e || event;
            e.preventDefault();
          }, false);

          window.addEventListener("drop", function (e) {
            e = e || event;
            e.preventDefault();
          }, false);

          return this;
        },

        /**
         * Render the editor components (data package view and metadata view),
         * or, if not authorized, render the not authorized message.
         */
        renderEditorComponents: function () {

          if (!MetacatUI.rootDataPackage.packageModel) {
            return
          }
          var resMapPermission = MetacatUI.rootDataPackage.packageModel.get("isAuthorized_write"),
            metadataPermission = this.model.get("isAuthorized_write");

          if (resMapPermission === true &amp;&amp; metadataPermission === true) {
            var view = this;
            // Render the Data Package table.
            // This function will also render metadata.
            view.renderDataPackage();
          } else if (resMapPermission === false || metadataPermission === false) {
            this.notAuthorized();
          }

        },

        /**
        * Fetch the metadata model
        */
        fetchModel: function () {

          //If the user hasn't provided an id, then don't check the authority and mark as synced already
          if (!this.pid) {
            this.model.trigger("sync");
          }
          else {
            //Fetch the model
            this.model.fetch();
          }
        },

        /**
        * @inheritdoc
        */
        isAccessPolicyEditEnabled: function(){

          if( !MetacatUI.appModel.get("allowAccessPolicyChanges") ){
            return false;
          }

          if( !MetacatUI.appModel.get("allowAccessPolicyChangesDatasets") ){
            return false;
          }

          let limitedTo = MetacatUI.appModel.get("allowAccessPolicyChangesDatasetsForSubjects");
          if( Array.isArray(limitedTo) &amp;&amp; limitedTo.length ){

            return _.intersection(limitedTo, MetacatUI.appUserModel.get("allIdentitiesAndGroups")).length > 0;

          }
          else{
            return true;
          }

        },

        /**
         * Update the text that is shown below the spinner while the editor is loading
         *
         * @param {string} message - The message to display
         */
        updateLoadingText: function (message) {
          try {
            if (!message || typeof message != "string") {
              console.log("Was not able to update the loading message, left it as-is. A message must be provided to the updateLoadingText function");
              return
            }
            var loadingPara = this.$el.find(".loading > p");
            if (loadingPara) {
              loadingPara.text(message)
            }
          } catch (error) {
            console.log("Was not able to update the loading message, left it as-is. Error details: " + error);
          }
        },

        /**
        * Get the data package (resource map) associated with the EML. Save it to MetacatUI.rootDataPackage.
        * The metadata model must already be synced, and the user must be authorized to edit the EML before this function
        * can run.
        * @param {Model} scimetaModel - The science metadata model for which to find the associated data package
        */
        getDataPackage: function (scimetaModel) {

          if (!scimetaModel)
            var scimetaModel = this.model;

          // Check if this package is obsoleted
          if (this.model.get("obsoletedBy")) {
            this.showLatestVersion();
            return;
          }

          var resourceMapIds = scimetaModel.get("resourceMap");

          // Case 1: No resource map PID found in the metadata
          if (typeof resourceMapIds === "undefined" || resourceMapIds === null || resourceMapIds.length &lt;= 0) {

            // 1A: Check if the rootDataPackage contains the metadata document the user is trying to edit.
            // Ensure the resource map is not new. If it's a previously unsaved map, then getLatestVersion
            // will result in a 404.
            if (
              MetacatUI.rootDataPackage &amp;&amp;
              MetacatUI.rootDataPackage.pluck &amp;&amp;
              !MetacatUI.rootDataPackage.packageModel.isNew() &amp;&amp;
              _.contains(MetacatUI.rootDataPackage.pluck("id"), this.model.get("id"))
            ) {

              // Remove the cached system metadata XML so we retrieve it again
              MetacatUI.rootDataPackage.packageModel.set("sysMetaXML", null);
              this.getLatestResourceMap();

            }

            // 1B. If the root data package does not contain the metadata the user is trying to edit,
            // then create a new data package.
            else {

              console.log("Resource map ids could not be found for " + scimetaModel.id + ", creating a new resource map.");

              // Create a new DataPackage collection for this view
              this.createDataPackage();
              this.trigger("dataPackageFound");
              // Set the listeners
              this.setListeners();
            }

            // Case 2: A resource map PID was found in the metadata
          } else {

            // Create a new data package with this id
            this.createRootDataPackage([this.model], { id: resourceMapIds[0] });

            //Handle the add of the metadata model
            MetacatUI.rootDataPackage.saveReference(this.model);

            // 2A. If there is more than one resource map, we need to make sure we fetch the most recent one
            if (resourceMapIds.length > 1) {
              this.getLatestResourceMap();

              // 2B. Just one resource map found
            } else {

              this.listenToOnce(MetacatUI.rootDataPackage, "sync", function () {
                this.trigger("dataPackageFound");
              })
              // Fetch the data package
              MetacatUI.rootDataPackage.fetch();
            }

          }

        },


        /**
         * Get the latest version of the resource map model stored in MetacatUI.rootDataPackage.packageModel.
         * When the newest resource map is synced, the "dataPackageFound" event will be triggered.
         */
        getLatestResourceMap: function () {

          try {

            if (!MetacatUI.rootDataPackage || !MetacatUI.rootDataPackage.packageModel) {
              console.log("Could not get the latest verion of the resource map because no resource map is saved.");
              return
            }
            // Make sure we have the latest version of the resource map before we allow editing
            this.listenToOnce(MetacatUI.rootDataPackage.packageModel, "latestVersionFound", function (model) {
              //Create a new data package for the latest version package
              this.createRootDataPackage([this.model], { id: model.get("latestVersion") });
              //Handle the add of the metadata model
              MetacatUI.rootDataPackage.saveReference(this.model);
              this.listenToOnce(MetacatUI.rootDataPackage, "sync", function () {
                this.trigger("dataPackageFound");
              })
              // Fetch the data package
              MetacatUI.rootDataPackage.fetch();
            });

            //Find the latest version of the resource map
            MetacatUI.rootDataPackage.packageModel.findLatestVersion();
          } catch (error) {
            console.log("Error attempting to find the latest version of the resource map. Error details: " + error);
          }
        },

        /**
        * Creates a DataPackage collection for this EML211EditorView and sets it on the MetacatUI
        * global object (as `rootDataPackage`)
        */
        createDataPackage: function () {
          // Create a new Data packages
          this.createRootDataPackage([this.model], { packageModelAttrs: { synced: true }})

          try{
            //Inherit the access policy of the metadata document, if the metadata document is not `new`
            if(!this.model.isNew()){
              let metadataAccPolicy = this.model.get("accessPolicy");
              let accPolicy = MetacatUI.rootDataPackage.packageModel.get("accessPolicy")

              //If there is no access policy, it hasn't been fetched yet, so wait
              if( !metadataAccPolicy.length ){
                //If the model is of ScienceMetadata class, we need to wait for the "replace" function,
                // which happens when the model is fetched and an EML211 model is created to replace it.
                if( this.model.type == "ScienceMetadata" ){
                   this.listenTo(this.model, "replace", function(){
                     this.listenToOnce(this.model, "sysMetaUpdated", function(){
                       accPolicy.copyAccessPolicy(this.model.get("accessPolicy"))
                       MetacatUI.rootDataPackage.packageModel.set("rightsHolder", this.model.get("rightsHolder"));
                     });
                   });
                }
              }
              else{
                accPolicy.copyAccessPolicy(this.model.get("accessPolicy"))
              }
            }
          }
          catch(e){
            console.error("Could not copy the access policy from the metadata to the resource map: ", e);
          }

          //Handle the add of the metadata model
          MetacatUI.rootDataPackage.handleAdd(this.model);

          // Associate the science metadata with the resource map
          if (this.model.get &amp;&amp; Array.isArray(this.model.get("resourceMap"))) {
            this.model.get("resourceMap").push(MetacatUI.rootDataPackage.packageModel.id);

          } else {
            this.model.set("resourceMap", MetacatUI.rootDataPackage.packageModel.id);

          }

          // Set the sysMetaXML for the packageModel
          MetacatUI.rootDataPackage.packageModel.set("sysMetaXML",
            MetacatUI.rootDataPackage.packageModel.serializeSysMeta());
        },

        /**
        * Creates a {@link DataPackage} collection for this Editor view, and saves it as the Root Data Package of the app.
        * This centralizes the DataPackage creation so listeners and other functionality is always performed
        * @param {(DataONEObject[]|ScienceMetadata[]|EML211[])} models - An array of models to add to the collection
        * @param {object} [attributes] A literal object of attributes to pass to the DataPackage.initialize() function
        * @since 2.17.1
        */
        createRootDataPackage: function(models, attributes){
          MetacatUI.rootDataPackage = new DataPackage(models, attributes);

          this.listenTo(MetacatUI.rootDataPackage.packageModel, "change:numLoadingFiles", this.toggleEnableControls);
        },

        renderChildren: function (model, options) {


        },

        /**
         * Render the Data Package View and insert it into this view
         */
        renderDataPackage: function () {

          var view = this;

          if(MetacatUI.rootDataPackage.packageModel.isNew()){
            view.renderMember(this.model);
          };

          // As the root collection is updated with models, render the UI
          this.listenTo(MetacatUI.rootDataPackage, "add", function (model) {

            if (!model.get("synced") &amp;&amp; model.get('id'))
              this.listenTo(model, "sync", view.renderMember);
            else if (model.get("synced"))
              view.renderMember(model);

            //Listen for changes on this member
            model.on("change:fileName", model.addToUploadQueue);
          });

          //Render the Data Package view
          this.dataPackageView = new DataPackageView({
            edit: true,
            dataPackage: MetacatUI.rootDataPackage,
            parentEditorView: this
          });

          //Render the view
          var $packageTableContainer = this.$("#data-package-container");
          $packageTableContainer.html(this.dataPackageView.render().el);

          //Make the view resizable on the bottom
          var handle = $(document.createElement("div"))
            .addClass("ui-resizable-handle ui-resizable-s")
            .attr("title", "Drag to resize")
            .append($(document.createElement("i")).addClass("icon icon-caret-down"));
          $packageTableContainer.after(handle);
          $packageTableContainer.resizable({
            handles: { "s": handle },
            minHeight: 100,
            maxHeight: 900,
            resize: function () {
              view.emlView.resizeTOC();
            }
          });

          var tableHeight = ($(window).height() - $("#Navbar").height()) * .40;
          $packageTableContainer.css("height", tableHeight + "px");

          var table = this.dataPackageView.$el;
          this.listenTo(this.dataPackageView, "addOne", function () {
            if (table.outerHeight() > $packageTableContainer.outerHeight() &amp;&amp; table.outerHeight() &lt; 220) {
              $packageTableContainer.css("height", table.outerHeight() + handle.outerHeight());
              if (this.emlView)
                this.emlView.resizeTOC();
            }
          });

          if (this.emlView)
            this.emlView.resizeTOC();

          //Save the view as a subview
          this.subviews.push(this.dataPackageView);

          this.listenTo(MetacatUI.rootDataPackage.packageModel, "change:childPackages", this.renderChildren);
        },


        /**
         * Calls the appropriate render method depending on the model type
         */
        renderMember: function (model, collection, options) {

          // Render metadata or package information, based on the type
          if (typeof model.attributes === "undefined") {
            return;

          } else {
            switch (model.get("type")) {
              case "DataPackage":
                // Do recursive rendering here for sub packages
                break;

              case "Metadata":

                // this.renderDataPackageItem(model, collection, options);
                this.renderMetadata(model, collection, options);
                break;

              case "Data":
                //this.renderDataPackageItem(model, collection, options);
                break;

              default:
                console.log("model.type is not set correctly");

            }
          }
        },


        /**
         * Renders the metadata section of the EML211EditorView
         */
        renderMetadata: function (model, collection, options) {

          if (!model &amp;&amp; this.model) var model = this.model;
          if (!model) return;

          var emlView, dataPackageView;

          // render metadata as the collection is updated, but only EML passed from the event
          if (typeof model.get === "undefined" ||
            !(
              model.get("formatId") === "eml://ecoinformatics.org/eml-2.1.1" ||
              model.get("formatId") === "https://eml.ecoinformatics.org/eml-2.2.0"
            )) {
            console.log("Not EML. TODO: Render generic ScienceMetadata.");
            return;

          }

          //Create an EML model
          if (model.type != "EML") {
              //Create a new EML model from the ScienceMetadata model
              var EMLmodel = new EML(model.toJSON());
              //Replace the old ScienceMetadata model in the collection
              MetacatUI.rootDataPackage.remove(model);
              MetacatUI.rootDataPackage.add(EMLmodel, { silent: true });
              MetacatUI.rootDataPackage.handleAdd(EMLmodel);
              model.trigger("replace", EMLmodel);

              //Fetch the EML and render it
              this.listenToOnce(EMLmodel, "sync", this.renderMetadata);
              EMLmodel.fetch();

              return;
            }

          //Create an EML211 View and render it
          emlView = new EMLView({
            model: model,
            edit: true
          });
          this.subviews.push(emlView);
          this.emlView = emlView;
          emlView.render();

          //Show the required fields for this editor
          this.renderRequiredIcons(this.getRequiredFields());
          this.listenTo(emlView, "editorInputsAdded", function(){
            this.trigger("editorInputsAdded")
          });

          // Create a citation view and render it
          var citationView = new CitationView({
            model: model,
            defaultTitle: "Untitled dataset",
            createLink: false,
            createTitleLink: !model.isNew()
          });

          this.subviews.push(citationView);
          $("#citation-container").html(citationView.render().$el);

          //Remove the rendering class from the body element
          $("body").removeClass("rendering");

          // Focus the folder name field once loaded but only if this is a new
          // document
          if (!this.pid) {
            $("#data-package-table-body td.name").focus();
          }

        },


        /**
         * Renders the data package section of the EML211EditorView
         */
        renderDataPackageItem: function (model, collection, options) {

          var hasPackageSubView =
            _.find(this.subviews, function (subview) {
              return subview.id === "data-package-table";
            }, model);

          // Only create the package table if it hasn't been created
          if (!hasPackageSubView) {
            this.dataPackageView = new DataPackageView({
              dataPackage: MetacatUI.rootDataPackage,
              edit: true,
              parentEditorView: this
            });
            this.subviews.push(this.dataPackageView);
            dataPackageView.render();

          }
        },

        /**
         * Set listeners on the view's model for various reasons.
         * This function centralizes all the listeners so that when/if the view's model is replaced, the listeners would be reset.
         */
        setListeners: function () {

          this.listenTo(this.model, "change:uploadStatus", this.showControls);

          // Register a listener for any attribute change
          this.model.on("change", this.model.handleChange, this.model);

          // Register a listener to save drafts on change
          this.model.on("change", this.model.saveDraft, this.model);

          // If any attributes have changed (including nested objects), show the controls
          if (typeof MetacatUI.rootDataPackage.packageModel !== "undefined") {
            this.stopListening(MetacatUI.rootDataPackage.packageModel, "change:changed");
            this.listenTo(MetacatUI.rootDataPackage.packageModel, "change:changed", this.toggleControls);
            this.listenTo(MetacatUI.rootDataPackage.packageModel, "change:changed", function (event) {
              if (MetacatUI.rootDataPackage.packageModel.get("changed")) {
                // Put this metadata model in the queue when the package has been changed
                // Don't put it in the queue if it's in the process of saving already
                if (this.model.get("uploadStatus") != "p")
                  this.model.set("uploadStatus", "q");
              }
            });

          }

          if (MetacatUI.rootDataPackage &amp;&amp; DataPackage.prototype.isPrototypeOf(MetacatUI.rootDataPackage)) {
            // If the Data Package failed saving, display an error message
            this.listenTo(MetacatUI.rootDataPackage, "errorSaving", this.saveError);

            // Listen for when the package has been successfully saved
            this.listenTo(MetacatUI.rootDataPackage, "successSaving", this.saveSuccess);

            //When the Data Package cancels saving, hide the saving styling
            this.listenTo(MetacatUI.rootDataPackage, "cancelSave", this.hideSaving);
            this.listenTo(MetacatUI.rootDataPackage, "cancelSave", this.handleSaveCancel);
          }

          //When the model is invalid, show the required fields
          this.listenTo(this.model, "invalid", this.showValidation);
          this.listenTo(this.model, "valid", this.showValidation);

          // When a data package member fails to load, remove it and warn the user
          this.listenTo(MetacatUI.eventDispatcher, "fileLoadError", this.handleFileLoadError);

          // When a data package member fails to be read, remove it and warn the user
          this.listenTo(MetacatUI.eventDispatcher, "fileReadError", this.handleFileReadError);

          //Set a beforeunload event only if there isn't one already
          if (!this.beforeunloadCallback) {
            var view = this;
            //When the Window is about to be closed, show a confirmation message
            this.beforeunloadCallback = function (e) {
              if (!view.canClose()) {
                //Browsers don't support custom confirmation messages anymore,
                // so preventDefault() needs to be called or the return value has to be set
                e.preventDefault();
                e.returnValue = "";
              }
              return;
            }
            window.addEventListener("beforeunload", this.beforeunloadCallback);
          }

        },

        /**
         * Saves all edits in the collection
         * @param {Event} e - The DOM Event that triggerd this function
         */
        save: function (e) {
          var btn = (e &amp;&amp; e.target) ? $(e.target) : this.$("#save-editor");

          //If the save button is disabled, then we don't want to save right now
          if (btn.is(".btn-disabled")) return;

          this.showSaving();

          //Save the package!
          MetacatUI.rootDataPackage.save();
        },

        /**
         * When the data package collection saves successfully, tell the user
         * @param {DataPackage|DataONEObject} savedObject - The model or collection that was just saved
         */
        saveSuccess: function (savedObject) {

          //We only want to perform these actions after the package saves
          if (savedObject.type != "DataPackage") return;

          //Change the URL to the new id
          MetacatUI.uiRouter.navigate("submit/" + encodeURIComponent(this.model.get("id")), { trigger: false, replace: true });

          this.toggleControls();

          // Construct the save message
          var message = this.editorSubmitMessageTemplate({
            messageText: "Your changes have been submitted.",
            viewURL: MetacatUI.root + "/view/" + encodeURIComponent(this.model.get("id")),
            buttonText: "View your dataset"
          });

          MetacatUI.appView.showAlert(message, "alert-success", this.$el, null, { remove: true });

          //Rerender the CitationView
          var citationView = _.where(this.subviews, { type: "Citation" });
          if (citationView.length) {
            citationView[0].createTitleLink = true;
            citationView[0].render();
          }

          // Reset the state to clean
          MetacatUI.rootDataPackage.packageModel.set("changed", false);
          this.model.set("hasContentChanges", false);

          this.setListeners();
        },

        /**
         * When the data package collection fails to save, tell the user
         * @param {string} errorMsg - The error message from the failed save() function
         */
        saveError: function (errorMsg) {

          var errorId = "error" + Math.round(Math.random() * 100),
            messageContainer = $(document.createElement("div")).append(document.createElement("p")),
            messageParagraph = messageContainer.find("p"),
            messageClasses = "alert-error";

          //Get all the models that have an error
          var failedModels = MetacatUI.rootDataPackage.where({ uploadStatus: "e" });

          //If every failed model is a DataONEObject data file that failed
          // because of a slow network, construct a specific error message that
          // is more informative than the usual message
          if (failedModels.length &amp;&amp;
            _.every(failedModels, function (m) {
              return m.get("type") == "Data" &amp;&amp;
                m.get("errorMessage").indexOf("network issue") > -1
            })) {

            //Create a list of file names for the files that failed to upload
            var failedFileList = $(document.createElement("ul"));

            _.each(failedModels, function (failedModel) {

              failedFileList.append($(document.createElement("li")).text(failedModel.get("fileName")));

            }, this);

            //Make the error message
            messageParagraph.text("The following files could not be uploaded due to a network issue. Make sure you are connected to a reliable internet connection. ");
            messageParagraph.after(failedFileList);
          }
          //If one of the failed models is this package's metadata model or the
          // resource map model and it failed to upload due to a network issue,
          // show a more specific error message
          else if (_.find(failedModels, function (m) {
            var errorMsg = m.get("errorMessage") || "";
            return (m == this.model &amp;&amp; errorMsg.indexOf("network issue") > -1)
          }, this) ||
            (MetacatUI.rootDataPackage.packageModel.get("uploadStatus") == "e" &amp;&amp;
              MetacatUI.rootDataPackage.packageModel.get("errorMessage").indexOf("network issue") > -1)) {

            messageParagraph.text("Your changes could not be submitted due to a network issue. Make sure you are connected to a reliable internet connection. ");

          }
          else {

            if (this.model.get("draftSaved") &amp;&amp; MetacatUI.appModel.get("editorSaveErrorMsgWithDraft")) {
              messageParagraph.text(MetacatUI.appModel.get("editorSaveErrorMsgWithDraft"));
              messageClasses = "alert-warning"
            }
            else if (MetacatUI.appModel.get("editorSaveErrorMsg")) {
              messageParagraph.text(MetacatUI.appModel.get("editorSaveErrorMsg"));
              messageClasses = "alert-error";
            }
            else {
              messageParagraph.text("Not all of your changes could be submitted.");
              messageClasses = "alert-error";
            }

            messageParagraph.after($(document.createElement("p")).append($(document.createElement("a"))
              .text("See technical details")
              .attr("data-toggle", "collapse")
              .attr("data-target", "#" + errorId)
              .addClass("pointer")),
              $(document.createElement("div"))
                .addClass("collapse")
                .attr("id", errorId)
                .append($(document.createElement("pre")).text(errorMsg)));
          }

          MetacatUI.appView.showAlert(messageContainer, messageClasses, this.$el, null, {
            emailBody: "Error message: Data Package save error: " + errorMsg,
            remove: true
          });

          //Reset the Saving styling
          this.hideSaving();
        },


        /**
         * Find the most recently updated version of the metadata
         */
        showLatestVersion: function () {
          var view = this;

          //When the latest version is found,
          this.listenToOnce(this.model, "change:latestVersion", function () {
            //Make sure it has a newer version, and if so,
            if (view.model.get("latestVersion") != view.model.get("id")) {
              //Get the obsoleted id
              var oldID = view.model.get("id");

              //Reset the current model
              view.pid = view.model.get("latestVersion");
              view.model = null;

              //Update the URL
              MetacatUI.uiRouter.navigate("submit/" + encodeURIComponent(view.pid), { trigger: false, replace: true });

              //Render the new model
              view.render();

              //Show a warning that the user was trying to edit old content
              MetacatUI.appView.showAlert("You've been forwarded to the newest version of your dataset for editing.",
                "alert-warning", this.$el, 12000, { remove: true });
            }
            else {
              view.getDataPackage();
            }

          });

          //Find the latest version of this metadata object
          this.model.findLatestVersion();
        },

        /**
         * Show the entity editor
         * @param {Event} e - The DOM Event that triggerd this function
         */
        showEntity: function (e) {
          if (!e || !e.target)
            return;

          //For EML metadata docs
          if (this.model.type == "EML") {
            //Get the Entity View
            var row = $(e.target).parents(".data-package-item"),
              entityView = row.data("entityView"),
              dataONEObject = row.data("model");

            if (dataONEObject.get("uploadStatus") == "p" || dataONEObject.get("uploadStatus") == "l" || dataONEObject.get("uploadStatus") == "e")
              return;

            //If there isn't a view yet, create one
            if (!entityView) {

              //Get the entity model for this data package item
              var entityModel = this.model.getEntity(row.data("model"));

              //Create a new EMLOtherEntity if it doesn't exist
              if (!entityModel) {
                entityModel = new EMLOtherEntity({
                  entityName: dataONEObject.get("fileName"),
                  entityType: dataONEObject.get("formatId") || dataONEObject.get("mediaType"),
                  parentModel: this.model,
                  xmlID: dataONEObject.getXMLSafeID()
                });

                if (!dataONEObject.get("fileName")) {
                  //Listen to changes to required fields on the otherEntity models
                  this.listenTo(entityModel, "change:entityName", function () {
                    if (!entityModel.isValid()) return;

                    //Get the position this entity will be in
                    var position = $(".data-package-item.data").index(row);

                    this.model.addEntity(entityModel, position);
                  });
                }
                else {
                  //Get the position this entity will be in
                  var position = $(".data-package-item.data").index(row);

                  this.model.addEntity(entityModel, position);
                }
              }
              else {
                entityView = new EMLEntityView({
                  model: entityModel,
                  DataONEObject: dataONEObject,
                  edit: true
                });
              }

              //Attach the view to the edit button so we can access it again
              row.data("entityView", entityView);

              //Render the view
              entityView.render();
            }

            //Show the modal window editor for this entity
            if (entityView)
              entityView.show();
          }

        },

        /**
         * Shows a message if the user is not authorized to edit this package
         */
        notAuthorized: function () {

          // Don't show the not authorized message if the user is authorized to edit the EML and the resource map
          if (MetacatUI.rootDataPackage &amp;&amp; MetacatUI.rootDataPackage.packageModel) {
            if (
              MetacatUI.rootDataPackage.packageModel.get("isAuthorized_changePermission") &amp;&amp;
              this.model.get("isAuthorized")
            ) {
              return
            }
          } else {
            if (this.model.get("isAuthorized")) {
              return
            }
          }

          this.$("#editor-body").empty();
          MetacatUI.appView.showAlert("You are not authorized to edit this data set.",
            "alert-error", "#editor-body");

          //Stop listening to any further events
          this.stopListening();
          this.model.off();
        },


        /**
         * Toggle the editor footer controls (Save bar)
         */
        toggleControls: function () {
          if (MetacatUI.rootDataPackage &amp;&amp;
            MetacatUI.rootDataPackage.packageModel &amp;&amp;
            MetacatUI.rootDataPackage.packageModel.get("changed")) {
            this.showControls();

          } else {
            this.hideControls();

          }
        },

        /**
        * Toggles whether the Save controls for the Editor are enabled or disabled based on various attributes of the DataPackage and its models.
        * @since 2.17.1
        */
        toggleEnableControls: function(){

          if( MetacatUI.rootDataPackage.packageModel.get("isLoadingFiles") ){
            let noun = MetacatUI.rootDataPackage.packageModel.get("numLoadingFiles") > 1? " files" : " file";
            this.disableControls("Waiting for " + MetacatUI.rootDataPackage.packageModel.get("numLoadingFiles") + noun + " to upload...");
          }
          else{
            this.enableControls();
          }

        },

        /**
         * Show any errors that occured when trying to save changes
         */
        showValidation: function () {

          //First clear all the error messaging
          this.$(".notification.error").empty();
          this.$(".side-nav-item .icon").hide();
          this.$("#metadata-container .error").removeClass("error");
          $(".alert-container:not(:has(.temporary-message))").remove();


          var errors = this.model.validationError;

          _.each(errors, function (errorMsg, category) {

            var categoryEls = this.$("[data-category='" + category + "']"),
                dataItemRow = categoryEls.parents(".data-package-item");

            //If this field is in a DataItemView, then delegate to that view
            if (dataItemRow.length &amp;&amp; dataItemRow.data("view")) {
              dataItemRow.data("view").showValidation(category, errorMsg);
              return;
            }
            else {
              var elsWithViews = _.filter(categoryEls, function (el) {
                return ($(el).data("view") &amp;&amp;
                  $(el).data("view").showValidation &amp;&amp;
                  !$(el).data("view").isNew);
              });

              if (elsWithViews.length) {
                _.each(elsWithViews, function (el) {
                  $(el).data("view").showValidation();
                });
              }
              else if(categoryEls.length) {
                //Show the error message
                categoryEls.filter(".notification").addClass("error").text(errorMsg);

                //Add the error message to inputs
                categoryEls.filter("textarea, input").addClass("error");
              }
            }

            //Get the link in the table of contents navigation
            var navigationLink = this.$(".side-nav-item[data-category='" + category + "']");

            if (!navigationLink.length) {
              var section = categoryEls.parents("[data-section]");
              navigationLink = this.$(".side-nav-item." + $(section).attr("data-section"));
            }

            //Show the error icon in the table of contents
            navigationLink.addClass("error")
              .find(".icon")
              .addClass("error")
              .show();

            this.model.off("change:" + category, this.model.checkValidity);
            this.model.once("change:" + category, this.model.checkValidity);

          }, this);

          if (errors) {

            //Create a list of errors to display in the error message shown to the user
            let errorList = "&lt;ul>" +
                            this.getErrorListItem(errors) +
                            "&lt;/ul>";


            MetacatUI.appView.showAlert("Fix the errors flagged below before submitting: " + errorList,
              "alert-error",
              this.$el,
              null,
              {
                remove: true
              });
          }

        },

        /**
        * @inheritdoc
        */
        hasUnsavedChanges: function () {
          //If the form hasn't been edited, we can close this view without confirmation
          if (typeof MetacatUI.rootDataPackage.getQueue != "function" || MetacatUI.rootDataPackage.getQueue().length)
            return true;
          else
            return false;
        },

        /**
        *  @inheritdoc
        */
        onClose: function () {

          //Execute the parent class onClose() function
          //EditorView.prototype.onClose.call(this);

          //Remove the listener on the Window
          if (this.beforeunloadCallback) {
            window.removeEventListener("beforeunload", this.beforeunloadCallback);
            delete this.beforeunloadCallback;
          }

          //Stop listening to the "add" event so that new package members aren't rendered.
          //Check first if the DataPackage has been intialized. An easy check is to see is
          // the 'models' attribute is undefined. If the DataPackage collection has been intialized,
          // then it would be an empty array.
          if (typeof MetacatUI.rootDataPackage.models !== "undefined") {
            this.stopListening(MetacatUI.rootDataPackage, "add");
          }

          //Remove all the other events
          this.off();    // remove callbacks, prevent zombies
          this.model.off();

          $(".Editor").removeClass("Editor");
          this.$el.empty();

          this.model = null;

          // Close each subview
          _.each(this.subviews, function (subview) {
            if (subview.onClose)
              subview.onClose();
          });

          this.subviews = [];

          this.undelegateEvents();

        },

        /**
         *  Handle "fileLoadError" events by alerting the user
         * and removing the row from the data package table.
         * @param  {DataONEObject} item The model item passed by the fileLoadError event
         */
        handleFileLoadError: function (item) {
          var message;
          var fileName;
          /* Remove the data package table row */
          this.dataPackageView.removeOne(item);
          /* Then inform the user */
          if (item &amp;&amp; item.get &amp;&amp;
            (item.get("fileName") !== "undefined" || item.get("fileName") !== null)) {
            fileName = item.get("fileName");
            message = "The file " + fileName +
              " is already included in this dataset. The duplicate file has not been added.";
          } else {
            message = "The chosen file is already included in this dataset. " +
              "The duplicate file has not been added.";
          }
          MetacatUI.appView.showAlert(message, "alert-info", this.el, 10000, { remove: true });
        },

        /**
         * Handle "fileReadError" events by alerting the user
         * and removing the row from the data package table.
         * @param  {DataONEObject} item The model item passed by the fileReadError event
         */
        handleFileReadError: function (item) {
          var message;
          var fileName;
          /* Remove the data package table row */
          this.dataPackageView.removeOne(item);
          /* Then inform the user */
          if (item &amp;&amp; item.get &amp;&amp;
            (item.get("fileName") !== "undefined" || item.get("fileName") !== null)) {
            fileName = item.get("fileName");
            message = "The file " + fileName +
              " could not be read. You may not have permission to read the file," +
              " or the file was too large for your browser to upload. " +
              "The file has not been added.";
          } else {
            message = "The chosen file " +
              " could not be read. You may not have permission to read the file," +
              " or the file was too large for your browser to upload. " +
              "The file has not been added.";
          }
          MetacatUI.appView.showAlert(message, "alert-info", this.el, 10000, { remove: true });
        },

        /**
         * Save a draft of the parent EML model
         */
        saveDraft: function () {
          var view = this;

          try {
            var title = this.model.get("title") || "No title";
            // Create a clone of the model that we will use for serialization.
            // Don't serialize the model that is currently being edited,
            // since serialize may make changes to the model that should not
            // happen until the user is ready to save
            // (e.g. - create a contact if there is not one)
            var draftModel = this.model.clone();

            LocalForage.setItem(this.model.get("id"), {
              id: this.model.get("id"),
              datetime: (new Date()).toISOString(),
              title: Array.isArray(title) ? title[0] : title,
              draft: draftModel.serialize()
            }).then(function () {
              view.clearOldDrafts();
            });
          } catch (ex) {
            console.log("Error saving draft:", ex);
          }
        },

        /**
         * Clear older drafts by iterating over the sorted list of drafts
         * stored by LocalForage and removing any beyond a hardcoded limit.
         */
        clearOldDrafts: function () {
          var drafts = [];

          try {
            LocalForage.iterate(function (value, key, iterationNumber) {
              // Extract each draft
              drafts.push({
                key: key,
                value: value
              });
            }).then(function () {
              // Sort by datetime
              drafts = _.sortBy(drafts, function (draft) {
                return draft.value.datetime.toString();
              }).reverse();
            }).then(function () {
              _.each(drafts, function (draft, i) {
                var age = (new Date()) - new Date(draft.value.datetime);
                var isOld = (age / 2678400000) > 1; // ~31days

                // Delete this draft is not in the most recent 100 or
                // if older than 31 days
                var shouldDelete = i > 100 || isOld;

                if (!shouldDelete) {
                  return;
                }

                LocalForage.removeItem(draft.key).then(function () {
                  // Item should be removed
                });
              });
            });
          }
          catch (ex) {
            console.log("Failed to clear old drafts: ", ex);
          }
        },

        /**
         * Show the AccessPolicy view in a modal dialog
         *
         * This method calls the superclass method, feeding it the identifier
         * associated with the row in the package table that was clicked. The
         * reason for this is so the AccessPolicyView can be used for single
         * objects (like in the Portal editor) or an entire Collection of
         * objects, like in the EML editor: The superclass impelements the
         * generic behavior and the subclass tweaks it.
         *
         * @param {EventHandler} e: The click event
         */
        showAccessPolicyModal: function(e) {
          var id = null;

          try {
            id = $(e.target).parents("tr").data("id");
          } catch (e) {
            console.log("Error determining the identifier to show an AccessPolicyView for:", e);
          }

          var model = MetacatUI.rootDataPackage.find(function(model) {
            return model.get("id") === id;
          });

          EditorView.prototype.showAccessPolicyModal.call(this, e, model);
        },

        /**
        * Gets the EML required fields, as configured in the {@link AppConfig#emlEditorRequiredFields}, and adds
        * possible other special fields that may be configured elsewhere. (e.g. the {@link AppConfig#customEMLMethods})
        * @extends EditorView.getRequiredFields
        */
        getRequiredFields: function(){
          let requiredFields = _.clone(MetacatUI.appModel.get("emlEditorRequiredFields"));

          //Add required fields for Custom Methods, which are configured in a different property of the AppConfig
          let customMethodOptions =  MetacatUI.appModel.get("customEMLMethods");
          if(customMethodOptions){
            customMethodOptions.forEach(options => {
              if( options.required &amp;&amp; !requiredFields[options.id] ){
                requiredFields[options.id] = true;
              }
            })
          }

          return requiredFields;

        }
      });
    return EML211EditorView;
  });
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
